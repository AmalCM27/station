<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ö–∞—Ä–∞–∫–æ–ª –ê–≤—Ç–æ–±–µ–∫–µ—Ç–∏</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #fff;
            min-height: 100vh;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(20px);
        }

        .login-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 20%, rgba(59, 130, 246, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 70% 80%, rgba(147, 51, 234, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 20% 80%, rgba(16, 185, 129, 0.2) 0%, transparent 50%);
            filter: blur(40px);
        }

        .login-box {
            position: relative;
            background: rgba(15, 23, 42, 0.9);
            padding: 50px;
            border-radius: 24px;
            text-align: center;
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            max-width: 450px;
            width: 90%;
        }

        .login-logo {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            font-size: 16px;
            color: #94a3b8;
            margin-bottom: 40px;
            font-weight: 400;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 24px;
            min-width: 320px;
        }

        .login-input {
            padding: 16px 24px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .login-input::placeholder {
            color: #64748b;
        }

        .login-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(15, 23, 42, 0.9);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .login-btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .login-error {
            color: #ef4444;
            margin-top: 10px;
            font-weight: 500;
            font-size: 14px;
        }

        .admin-screen {
            display: none;
        }

        .admin-screen.active {
            display: block;
        }

        .header {
            background: #1e3a8a;
            padding: 20px 40px;
            text-align: center;
            border-bottom: 3px solid #3b82f6;
            position: relative;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 16px;
            color: #94a3b8;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .day-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .day-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .day-start {
            background: #22c55e;
            color: #fff;
        }

        .day-start:hover {
            background: #16a34a;
        }

        .day-end {
            background: #f59e0b;
            color: #fff;
        }

        .day-end:hover {
            background: #d97706;
        }

        .day-status {
            position: absolute;
            top: 70px;
            left: 20px;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .day-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .day-inactive {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
            border: 1px solid #6b7280;
        }

        .nav {
            background: #1e293b;
            padding: 0;
            display: flex;
            border-bottom: 1px solid #334155;
        }

        .nav-item {
            flex: 1;
            padding: 18px 20px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-right: 1px solid #334155;
        }

        .nav-item:last-child {
            border-right: none;
        }

        .nav-item.active {
            background: #3b82f6;
            color: #fff;
        }

        .nav-item:hover:not(.active) {
            background: #374151;
            color: #fff;
        }

        .content {
            padding: 30px 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .section {
            display: none;
            margin-bottom: 40px;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1e293b;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #cbd5e1;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            background: #1e293b;
            border: 1px solid #334155;
            color: #fff;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            background: #262d3d;
        }

        .form-group input::placeholder {
            color: #64748b;
        }

        .btn {
            background: #3b82f6;
            border: none;
            color: #fff;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-warning {
            background: #f59e0b;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .routes-list {
            background: #1e293b;
            border-radius: 8px;
            border: 1px solid #334155;
            overflow: hidden;
        }

        .route-item {
            display: grid;
            grid-template-columns: 180px 100px 120px 80px 80px 80px 140px 120px 100px 1fr;
            gap: 15px;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #334155;
            transition: all 0.3s ease;
        }

        .route-item:last-child {
            border-bottom: none;
        }

        .route-item:hover {
            background: #262d3d;
        }

        .route-item.header {
            background: #334155;
            font-weight: 600;
            color: #3b82f6;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .route-item.header:hover {
            background: #334155;
        }

        .route-field {
            font-size: 14px;
            color: #e2e8f0;
        }

        .route-time {
            font-family: 'Inter', monospace;
            font-weight: 500;
            color: #fbbf24;
        }

        .route-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            text-transform: uppercase;
        }

        .status-waiting {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-boarding {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-delayed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-departed {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }

        .route-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 300;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .template-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            border-color: #3b82f6;
            background: #262d3d;
        }

        .template-title {
            font-size: 18px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .template-desc {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .template-routes {
            max-height: 150px;
            overflow-y: auto;
        }

        .template-route {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #334155;
            font-size: 12px;
            color: #cbd5e1;
        }

        .template-route:last-child {
            border-bottom: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #10b981;
            color: #fff;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.warning {
            background: #f59e0b;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #334155;
            max-width: 95vw;
            width: 95%;
            max-height: 95vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .template-route-editor {
            display: grid;
            grid-template-columns: 1fr 100px 80px 80px 100px 120px 100px 30px;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 15px;
            background: #374151;
            border-radius: 6px;
        }

        .template-route-editor input,
        .template-route-editor select {
            padding: 8px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            color: #fff;
            border-radius: 4px;
            font-size: 14px;
        }

        .template-route-editor label {
            color: #cbd5e1;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .history-list {
            background: #1e293b;
            border-radius: 8px;
            border: 1px solid #334155;
            overflow: hidden;
            margin-top: 20px;
        }

        .history-item {
            padding: 15px 20px;
            border-bottom: 1px solid #334155;
            transition: all 0.3s ease;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: #262d3d;
        }

        .history-timestamp {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .history-action {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .history-details {
            font-size: 12px;
            color: #cbd5e1;
        }

        .report-container {
            background: #1e293b;
            border-radius: 8px;
            border: 1px solid #334155;
            padding: 20px;
            margin-top: 20px;
        }

        .report-section {
            margin-bottom: 30px;
        }

        .report-title {
            font-size: 18px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 15px;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .report-stat {
            background: #374151;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .report-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #22c55e;
            margin-bottom: 5px;
        }

        .report-stat-label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .nav {
                flex-direction: column;
            }

            .route-item {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: left;
            }

            .route-item.header {
                display: none;
            }

            .template-route-editor {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 98vw;
                width: 98%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="login-screen" id="login-screen">
        <div class="login-box">
            <div class="login-logo">üöå</div>
            <div class="login-title">–ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò</div>
            <div class="login-subtitle">–ë–∞—à–∫–∞—Ä—É—É –ø–∞–Ω–µ–ª–∏ ‚Ä¢ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
            <div class="login-form">
                <input type="text" class="login-input" id="username" placeholder="–ö–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã ‚Ä¢ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="password" class="login-input" id="password" placeholder="–°—ã—Ä —Å”©–∑ ‚Ä¢ –ü–∞—Ä–æ–ª—å">
                <button class="login-btn" onclick="login()">–ö–ò–†“Æ“Æ ‚Ä¢ –í–û–ô–¢–ò</button>
                <div class="login-error" id="login-error"></div>
            </div>
        </div>
    </div>

    <div class="admin-screen" id="admin-screen">
        <div class="header">
            <div class="day-controls">
                <button class="day-btn day-start" onclick="startDay()">üåÖ –ö“Ø–Ω –±–∞—à—Ç–∞–ª–¥—ã</button>
                <button class="day-btn day-end" onclick="endDay()">üåô –ö“Ø–Ω –∞—è–∫—Ç–∞–¥—ã</button>
            </div>
            <div class="day-status" id="day-status">–ö“Ø–Ω –±–∞—à—Ç–∞–ª–≥–∞–Ω –∂–æ–∫</div>
            <h1>üöå –ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò - –ê–î–ú–ò–ù</h1>
            <p>–ë–∞—à–∫–∞—Ä—É—É –ø–∞–Ω–µ–ª–∏ ‚Ä¢ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
            <button class="logout-btn" onclick="logout()">–ß–´–ì–£–£</button>
        </div>

        <div class="nav">
            <button class="nav-item active" onclick="showSection('manage')">–ë–∞—à–∫–∞—Ä—É—É</button>
            <button class="nav-item" onclick="showSection('templates')">–®–∞–±–ª–æ–Ω–¥–æ—Ä</button>
            <button class="nav-item" onclick="showSection('history')">–¢–∞—Ä—ã—Ö</button>
            <button class="nav-item" onclick="showSection('reports')">–û—Ç—á–µ—Ç—Ç–æ—Ä</button>
            <button class="nav-item" onclick="showSection('settings')">–ñ”©–Ω–¥”©”©–ª”©—Ä</button>
        </div>

        <div class="content">
            <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï -->
            <div class="section active" id="manage-section">
                <div class="section-title">–ñ–∞“£—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∫–æ—à—É—É</div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>–ë–∞–≥—ã—Ç ‚Ä¢ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                        <input type="text" id="route" placeholder="–ë–∏—à–∫–µ–∫">
                    </div>
                    <div class="form-group">
                        <label>–ö“Ø–Ω“Ø ‚Ä¢ –î–∞—Ç–∞</label>
                        <input type="date" id="bus-date">
                    </div>
                    <div class="form-group">
                        <label>–£–±–∞–∫—ã—Ç ‚Ä¢ –í—Ä–µ–º—è</label>
                        <input type="time" id="time">
                    </div>
                    <div class="form-group">
                        <label>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç —Ç“Ø—Ä“Ø ‚Ä¢ –í–∏–¥ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</label>
                        <select id="vehicle">
                            <option value="bus">–ê–≤—Ç–æ–±—É—Å</option>
                            <option value="minibus">–ú–∞—Ä—à—Ä—É—Ç–∫–∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–û—Ä—É–Ω–¥–∞—Ä ‚Ä¢ –ú–µ—Å—Ç–∞</label>
                        <input type="number" id="seats" placeholder="45" min="10" max="80">
                    </div>
                    <div class="form-group">
                        <label>–ë–æ—à –æ—Ä—É–Ω–¥–∞—Ä ‚Ä¢ –°–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞</label>
                        <input type="number" id="available" placeholder="45" min="0" max="80">
                    </div>
                    <div class="form-group">
                        <label>–ê–π–¥–æ–æ—á—É ‚Ä¢ –í–æ–¥–∏—Ç–µ–ª—å</label>
                        <input type="text" id="driver" placeholder="–≠–º–∏–ª–±–µ–∫ —É—É–ª—É">
                    </div>
                    <div class="form-group">
                        <label>–¢–∞—à—É—É—á—É ‚Ä¢ –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫</label>
                        <input type="text" id="carrier" placeholder="–ö–∞—Ä–∞–∫–æ–ª –¢—Ä–∞–Ω—Å">
                    </div>
                    <div class="form-group">
                        <label>–ë–∞–∞—Å—ã ‚Ä¢ –¶–µ–Ω–∞ (—Å–æ–º)</label>
                        <input type="number" id="price" placeholder="350" min="50">
                    </div>
                    <div class="form-group">
                        <label>–ê–±–∞–ª—ã ‚Ä¢ –°—Ç–∞—Ç—É—Å</label>
                        <select id="status">
                            <option value="waiting">–ö“Ø—Ç“Ø“Ø–¥”©</option>
                            <option value="boarding">–û—Ç—É—Ä–≥—É–∑—É—É</option>
                            <option value="delayed">–ö–µ—á–∏–≥“Ø“Ø</option>
                            <option value="departed">–ö–µ—Ç—Ç–∏</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <button class="btn" onclick="addBus()">‚ûï –ö–æ—à—É—É</button>
                    <button class="btn btn-success" onclick="clearForm()">üîÑ –¢–∞–∑–∞–ª–æ–æ</button>
                    <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è –ë–∞–∞—Ä—ã–Ω ”©—á“Ø—Ä“Ø“Ø</button>
                </div>

                <div class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-count">0</div>
                        <div class="stat-label">–ë–∞—Ä–¥—ã–≥—ã</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="waiting-count">0</div>
                        <div class="stat-label">–ö“Ø—Ç“Ø“Ø–¥”©</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="boarding-count">0</div>
                        <div class="stat-label">–û—Ç—É—Ä–≥—É–∑—É—É</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="departed-count">0</div>
                        <div class="stat-label">–ö–µ—Ç—Ç–∏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-revenue">0</div>
                        <div class="stat-label">–ö–∏—Ä–µ—à–µ (—Å–æ–º)</div>
                    </div>
                </div>

                <div class="section-title">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç</div>
                <div class="routes-list">
                    <div class="route-item header">
                        <div>–ë–∞–≥—ã—Ç</div>
                        <div>–£–±–∞–∫—ã—Ç</div>
                        <div>–ê–±–∞–ª—ã</div>
                        <div>–í–∏–¥</div>
                        <div>–û—Ä—É–Ω–¥–∞—Ä</div>
                        <div>–ë–æ—à –æ—Ä—É–Ω–¥–∞—Ä</div>
                        <div>–ê–π–¥–æ–æ—á—É</div>
                        <div>–¢–∞—à—É—É—á—É</div>
                        <div>–ë–∞–∞—Å—ã</div>
                        <div>–ê—Ä–∞–∫–µ—Ç—Ç–µ—Ä</div>
                    </div>
                    <div id="routes-container">
                        <!-- –†–µ–π—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>

            <!-- –®–ê–ë–õ–û–ù–´ -->
            <div class="section" id="templates-section">
                <div class="section-title">–®–∞–±–ª–æ–Ω–¥–æ—Ä –∂–∞–Ω–∞ –º–∞—Å—Å–∞–ª—ã–∫ –∞—Ä–∞–∫–µ—Ç—Ç–µ—Ä</div>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn" onclick="showCreateTemplateModal()">‚ûï –ñ–∞“£—ã —à–∞–±–ª–æ–Ω</button>
                    <button class="btn btn-secondary" onclick="importFromFile()">üìÅ –ò–º–ø–æ—Ä—Ç</button>
                    <button class="btn btn-success" onclick="exportToFile()">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
                </div>

                <div class="templates-grid" id="templates-container">
                    <!-- –®–∞–±–ª–æ–Ω—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>

                <div class="section-title">–ú–∞—Å—Å–∞–ª—ã–∫ –∞—Ä–∞–∫–µ—Ç—Ç–µ—Ä</div>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="updateAllStatuses('boarding')">üü¢ –ë–∞–∞—Ä—ã–Ω –æ—Ç—É—Ä–≥—É–∑—É—É–≥–∞</button>
                    <button class="btn btn-secondary" onclick="updateAllStatuses('delayed')">üü° –ë–∞–∞—Ä—ã–Ω –∫–µ—á–∏–∫—Ç–∏—Ä“Ø“Ø</button>
                    <button class="btn btn-danger" onclick="updateAllStatuses('departed')">üî¥ –ë–∞–∞—Ä—ã–Ω –∂”©–Ω”©—Ç“Ø“Ø</button>
                </div>
            </div>

            <!-- –ò–°–¢–û–†–ò–Ø -->
            <div class="section" id="history-section">
                <div class="section-title">–°–∏—Å—Ç–µ–º–∞–Ω—ã–Ω —Ç–∞—Ä—ã—Ö—ã</div>
                
                <div class="form-grid" style="max-width: 600px;">
                    <div class="form-group">
                        <label>–ö“Ø–Ω“Ø —Ç–∞–Ω–¥–æ–æ</label>
                        <input type="date" id="history-date">
                    </div>
                    <div class="form-group">
                        <label>–ê—Ä–∞–∫–µ—Ç —Ç“Ø—Ä“Ø</label>
                        <select id="history-filter">
                            <option value="">–ë–∞–∞—Ä–¥—ã–∫ –∞—Ä–∞–∫–µ—Ç—Ç–µ—Ä</option>
                            <option value="add">–ö–æ—à—É—É</option>
                            <option value="edit">”®–∑–≥”©—Ä—Ç“Ø“Ø</option>
                            <option value="delete">”®—á“Ø—Ä“Ø“Ø</option>
                            <option value="status">–°—Ç–∞—Ç—É—Å ”©–∑–≥”©—Ä—Ç“Ø“Ø</option>
                            <option value="day_start">–ö“Ø–Ω –±–∞—à—Ç–∞–ª–¥—ã</option>
                            <option value="day_end">–ö“Ø–Ω –∞—è–∫—Ç–∞–¥—ã</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" onclick="loadHistory()">üìä –¢–∞—Ä—ã—Ö—Ç—ã –∂“Ø–∫—Ç”©”©</button>
                
                <div id="history-container" style="margin-top: 30px;">
                    <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>

            <!-- –û–¢–ß–ï–¢–´ -->
            <div class="section" id="reports-section">
                <div class="section-title">–û—Ç—á–µ—Ç—Ç–æ—Ä –∂–∞–Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
                
                <div class="form-grid" style="max-width: 600px;">
                    <div class="form-group">
                        <label>–û—Ç—á–µ—Ç –∫“Ø–Ω“Ø</label>
                        <input type="date" id="report-date">
                    </div>
                    <div class="form-group">
                        <label>–û—Ç—á–µ—Ç —Ç“Ø—Ä“Ø</label>
                        <select id="report-type">
                            <option value="daily">–ö“Ø–Ω–¥“Ø–∫</option>
                            <option value="weekly">–ñ—É–º–∞–ª—ã–∫</option>
                            <option value="monthly">–ê–π–ª—ã–∫</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn" onclick="generateReport()">üìä –û—Ç—á–µ—Ç —Ç“Ø–∑“Ø“Ø</button>
                    <button class="btn btn-warning" onclick="exportToText()">üìÑ –¢–µ–∫—Å—Ç —Ñ–∞–π–ª</button>
                    <button class="btn btn-success" onclick="exportToExcel()">üìä Excel</button>
                </div>
                
                <div id="report-container">
                    <!-- –û—Ç—á–µ—Ç—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>

            <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
            <div class="section" id="settings-section">
                <div class="section-title">–°–∏—Å—Ç–µ–º–∞ –∂”©–Ω–¥”©”©–ª”©—Ä“Ø</div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>–ñ–∞“£—ã—Ä—Ç—É—É –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (—Å–µ–∫)</label>
                        <input type="number" id="update-interval" value="3" min="1" max="60">
                    </div>
                    <div class="form-group">
                        <label>–î–æ–±—É—à –∫“Ø—á“Ø</label>
                        <input type="range" id="volume" min="0" max="1" step="0.1" value="0.8">
                        <span id="volume-display">80%</span>
                    </div>
                    <div class="form-group">
                        <label>–ê–≤—Ç–æ ”©—á“Ø—Ä“Ø“Ø (–º“Ø–Ω”©—Ç)</label>
                        <input type="number" id="auto-remove" value="2" min="1" max="60">
                    </div>
                    <div class="form-group">
                        <label>–û–±—ä—è–≤–ª–µ–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫)</label>
                        <input type="number" id="announcement-interval" value="10" min="5" max="60">
                    </div>
                    <div class="form-group">
                        <label>–ê–¥–º–∏–Ω –ø–∞—Ä–æ–ª—å (–∂–∞“£—ã)</label>
                        <input type="password" id="admin-password" placeholder="–ñ–∞“£—ã –ø–∞—Ä–æ–ª—å">
                    </div>
                    <div class="form-group">
                        <label>–ê–¥–º–∏–Ω –ø–∞—Ä–æ–ª—å (—Ç–∞—Å—Ç—ã–∫—Ç–æ–æ)</label>
                        <input type="password" id="admin-password-confirm" placeholder="–ü–∞—Ä–æ–ª–¥—É –∫–∞–π—Ç–∞–ª–∞“£—ã–∑">
                    </div>
                    <div class="form-group">
                        <label>–û–ø–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª—å (–∂–∞“£—ã)</label>
                        <input type="password" id="operator-password" placeholder="–ñ–∞“£—ã –ø–∞—Ä–æ–ª—å">
                    </div>
                    <div class="form-group">
                        <label>–û–ø–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª—å (—Ç–∞—Å—Ç—ã–∫—Ç–æ–æ)</label>
                        <input type="password" id="operator-password-confirm" placeholder="–ü–∞—Ä–æ–ª–¥—É –∫–∞–π—Ç–∞–ª–∞“£—ã–∑">
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <button class="btn" onclick="saveSettings()">üíæ –°–∞–∫—Ç–æ–æ</button>
                    <button class="btn btn-secondary" onclick="testAnnouncement()">üîä –î–æ–±—É—à —Ç–µ—Å—Ç–∏</button>
                    <button class="btn btn-warning" onclick="showCurrentUsers()">üë• –ö–æ–ª–¥–æ–Ω—É—É—á—É–ª–∞—Ä</button>
                    <button class="btn btn-success" onclick="changePasswords()">üîê –ü–∞—Ä–æ–ª–¥–æ—Ä–¥—É ”©–∑–≥”©—Ä—Ç“Ø“Ø</button>
                    <button class="btn btn-danger" onclick="resetSystem()">üîÑ –°–∏—Å—Ç–µ–º–∞–Ω—ã –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä“Ø“Ø</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-title">–ú–æ–¥–∞–ª</div>
            <div id="modal-body">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª–∞ -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">–ñ–∞–±—É—É</button>
                <button class="btn" id="modal-confirm" onclick="confirmModal()">–´—Ä–∞–∞–∑—ã</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let buses = [];
        let busCounter = 1;
        let currentUser = null;
        let dayStarted = false;
        let currentDayId = null;
        let templateRouteCounter = 0;

        let database = {
            buses: [],
            deleted: [],
            history: [],
            templates: {},
            days: []
        };

        function checkAdminAccess() {
            const savedSession = JSON.parse(localStorage.getItem('karakol-admin-session') || 'null');
            if (!savedSession) {
                goToLogin();
                return false;
            }

            if (savedSession.expires < Date.now()) {
                localStorage.removeItem('karakol-admin-session');
                goToLogin();
                return false;
            }

            if (savedSession.role !== 'admin') {
                goToLogin();
                return false;
            }

            currentUser = savedSession;
            return true;
        }

        function goToLogin() {
            window.location.href = 'index.html';
        }

        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorEl = document.getElementById('login-error');

            if (!username || !password) {
                errorEl.textContent = '–ö–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã –∂–∞–Ω–∞ —Å—ã—Ä —Å”©–∑ –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑!';
                return;
            }

            const savedUsers = getUsers();
            
            if (savedUsers[username] && savedUsers[username].password === password) {
                if (savedUsers[username].role !== 'admin') {
                    errorEl.textContent = '–ê–¥–º–∏–Ω —É–∫—É–∫—Ç–∞—Ä—ã –∂–æ–∫!';
                    return;
                }

                const sessionData = {
                    username: username,
                    role: savedUsers[username].role,
                    name: savedUsers[username].name,
                    loginTime: Date.now(),
                    expires: Date.now() + (24 * 60 * 60 * 1000)
                };

                localStorage.setItem('karakol-admin-session', JSON.stringify(sessionData));
                currentUser = sessionData;

                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-screen').classList.add('active');
                init();
            } else {
                errorEl.textContent = '–¢—É—É—Ä–∞ —ç–º–µ—Å –∫–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã –∂–µ —Å—ã—Ä —Å”©–∑!';
            }
        }

        function logout() {
            localStorage.removeItem('karakol-admin-session');
            localStorage.removeItem('karakol-session');
            window.location.href = 'index.html';
        }

        function getUsers() {
            const savedUsers = JSON.parse(localStorage.getItem('karakol-users') || '{}');
            if (Object.keys(savedUsers).length === 0) {
                const defaultUsers = {
                    admin: { password: 'admin123', role: 'admin', name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' },
                    operator: { password: 'display123', role: 'operator', name: '–û–ø–µ—Ä–∞—Ç–æ—Ä' }
                };
                localStorage.setItem('karakol-users', JSON.stringify(defaultUsers));
                return defaultUsers;
            }
            return savedUsers;
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('login-screen').style.display !== 'none') {
                login();
            }
        });

        function startDay() {
            if (dayStarted) {
                showNotification('–ö“Ø–Ω –º—É—Ä–¥–∞ –±–∞—à—Ç–∞–ª–≥–∞–Ω!', 'warning');
                return;
            }

            currentDayId = Date.now();
            dayStarted = true;
            
            const dayData = {
                id: currentDayId,
                startTime: new Date(),
                endTime: null,
                totalBuses: 0,
                totalRevenue: 0
            };
            
            database.days.push(dayData);
            addToHistory('day_start', null, { dayId: currentDayId });
            
            // –°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ –Ω–∞—á–∞–ª–µ –¥–Ω—è
            const displayData = JSON.parse(localStorage.getItem('karakol-bus-station-display') || '{}');
            displayData.dayStarted = true;
            displayData.dayEnded = false;
            displayData.buses = getCurrentBuses();
            localStorage.setItem('karakol-bus-station-display', JSON.stringify(displayData));
            
            updateDayStatus();
            saveData();
            showNotification('–ö“Ø–Ω –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –±–∞—à—Ç–∞–ª–¥—ã! üåÖ');
        }

        function endDay() {
            if (!dayStarted) {
                showNotification('–ö“Ø–Ω –±–∞—à—Ç–∞–ª–≥–∞–Ω –∂–æ–∫!', 'error');
                return;
            }

            const dayData = database.days.find(d => d.id === currentDayId);
            if (dayData) {
                dayData.endTime = new Date();
                dayData.totalBuses = buses.length;
                dayData.totalRevenue = calculateTotalRevenue();
            }

            addToHistory('day_end', null, { 
                dayId: currentDayId, 
                totalBuses: buses.length, 
                totalRevenue: calculateTotalRevenue() 
            });

            buses.forEach(bus => {
                if (bus.status !== 'departed') {
                    bus.status = 'departed';
                    bus.departedTime = new Date();
                    addToHistory('status', bus, { oldStatus: bus.status, newStatus: 'departed', reason: 'day_end' });
                }
            });

            dayStarted = false;
            currentDayId = null;
            
            // –°–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –¥–Ω—è
            const displayData = JSON.parse(localStorage.getItem('karakol-bus-station-display') || '{}');
            displayData.dayEnded = true;
            displayData.buses = getCurrentBuses();
            localStorage.setItem('karakol-bus-station-display', JSON.stringify(displayData));
            
            updateDayStatus();
            updateDisplay();
            saveData();
            showNotification('–ö“Ø–Ω –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∞—è–∫—Ç–∞–¥—ã! üåô');
        }

        function updateDayStatus() {
            const statusEl = document.getElementById('day-status');
            if (dayStarted) {
                statusEl.textContent = '–ö“Ø–Ω –±–∞—à—Ç–∞–ª–≥–∞–Ω';
                statusEl.className = 'day-status day-active';
            } else {
                statusEl.textContent = '–ö“Ø–Ω –±–∞—à—Ç–∞–ª–≥–∞–Ω –∂–æ–∫';
                statusEl.className = 'day-status day-inactive';
            }
        }

        function calculateTotalRevenue() {
            const currentBuses = getCurrentBuses();
            return currentBuses.reduce((sum, bus) => {
                const occupiedSeats = bus.seats - (bus.available || 0);
                return sum + (occupiedSeats * (bus.price || 0));
            }, 0);
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showSection(sectionName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(sectionName + '-section').classList.add('active');
            
            if (sectionName === 'history') {
                document.getElementById('history-date').value = getTodayDate();
            }
            if (sectionName === 'reports') {
                document.getElementById('report-date').value = getTodayDate();
            }
            if (sectionName === 'templates') {
                renderTemplates();
            }
        }

        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        function setDefaultTime() {
            const now = new Date();
            const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
            document.getElementById('time').value = oneHourLater.toTimeString().slice(0, 5);
        }

        function parseTimeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function validateDateTime() {
            const selectedTime = document.getElementById('time').value;
            const selectedDate = document.getElementById('bus-date').value;
            
            if (!selectedTime || !selectedDate) {
                showNotification('–£–±–∞–∫—ã—Ç –∂–∞–Ω–∞ –∫“Ø–Ω“Ø–Ω —Ç–∞–Ω–¥–∞“£—ã–∑!', 'error');
                return false;
            }
            
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            
            if (selectedDate < currentDate) {
                showNotification('”®—Ç–∫”©–Ω –∫“Ø–Ω–≥”© —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∫–æ—à—É—É–≥–∞ –±–æ–ª–±–æ–π—Ç!', 'error');
                return false;
            }
            
            if (selectedDate === currentDate) {
                const [hours, minutes] = selectedTime.split(':').map(Number);
                const selectedTimeInMinutes = hours * 60 + minutes;
                const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
                
                if (selectedTimeInMinutes <= currentTimeInMinutes) {
                    showNotification('”®—Ç–∫”©–Ω —É–±–∞–∫—ã—Ç–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∫–æ—à—É—É–≥–∞ –±–æ–ª–±–æ–π—Ç!', 'error');
                    return false;
                }
            }
            
            return true;
        }

        function addBus() {
            if (!dayStarted) {
                showNotification('–ê–ª–≥–∞—á –∫“Ø–Ω–¥“Ø –±–∞—à–∞—Ç—ã“£—ã–∑!', 'error');
                return;
            }

            const route = document.getElementById('route').value.trim();
            const time = document.getElementById('time').value;
            const vehicle = document.getElementById('vehicle').value;
            const seats = parseInt(document.getElementById('seats').value);
            const available = parseInt(document.getElementById('available').value);
            const driver = document.getElementById('driver').value.trim();
            const carrier = document.getElementById('carrier').value.trim();
            const price = parseInt(document.getElementById('price').value);
            const status = document.getElementById('status').value;
            const busDate = document.getElementById('bus-date').value;

            if (!route || !time || !seats || !driver || !carrier || !price) {
                showNotification('–ë–∞—Ä–¥—ã–∫ —Ç–∞–ª–∞–∞–ª–∞—Ä–¥—ã —Ç–æ–ª—Ç—É—Ä—É“£—É–∑!', 'error');
                return;
            }

            if (!validateDateTime()) {
                return;
            }

            if (seats < 10 || seats > 80) {
                showNotification('–û—Ä—É–Ω–¥–∞—Ä —Å–∞–Ω—ã 10–¥–æ–Ω 80–≥”© —á–µ–π–∏–Ω –±–æ–ª—É—à—É –∫–µ—Ä–µ–∫!', 'error');
                return;
            }

            if (available > seats) {
                showNotification('–ë–æ—à –æ—Ä—É–Ω–¥–∞—Ä –∂–∞–ª–ø—ã –æ—Ä—É–Ω–¥–∞—Ä–¥–∞–Ω –∫”©–ø –±–æ–ª–±–æ—à—É –∫–µ—Ä–µ–∫!', 'error');
                return;
            }

            if (price < 50) {
                showNotification('–ë–∞–∞—Å—ã –∫–µ–º–∏–Ω–¥–µ 50 —Å–æ–º –±–æ–ª—É—à—É –∫–µ—Ä–µ–∫!', 'error');
                return;
            }

            const newBus = {
                id: busCounter++,
                route, time, vehicle, seats, available: available || seats, 
                driver, carrier, price, status,
                date: busDate,
                created: new Date(),
                dayId: currentDayId,
                announcements: {
                    fiveMinutes: false,
                    boarding: false,
                    departed: false,
                    statusManual: false
                }
            };

            buses.push(newBus);
            addToHistory('add', newBus);
            saveData();
            clearForm();
            updateDisplay();
            setDefaultTime();
            showNotification(`${route} –±–∞–≥—ã—Ç—ã–Ω–∞ ${getVehicleText(vehicle)} –∫–æ—à—É–ª–¥—É!`);
        }

        function getVehicleText(vehicle) {
            return vehicle === 'bus' ? '–∞–≤—Ç–æ–±—É—Å' : '–º–∞—Ä—à—Ä—É—Ç–∫–∞';
        }

        function deleteBus(busId) {
            const bus = buses.find(b => b.id === busId);
            if (!bus) return;

            if (confirm(`${bus.route} –±–∞–≥—ã—Ç—ã–Ω–¥–∞–≥—ã ${getVehicleText(bus.vehicle)}—Ç—ã ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?`)) {
                const busIndex = buses.findIndex(b => b.id === busId);
                database.deleted.push({
                    ...bus,
                    deletedAt: new Date(),
                    deletedBy: 'admin'
                });
                buses.splice(busIndex, 1);
                addToHistory('delete', bus);
                saveData();
                updateDisplay();
                showNotification(`${bus.route} ${getVehicleText(bus.vehicle)}—ã ”©—á“Ø—Ä“Ø–ª–¥“Ø`);
            }
        }

        function changeStatus(busId) {
            const bus = buses.find(b => b.id === busId);
            if (!bus) return;

            // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞: –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º departed –æ–±—Ä–∞—Ç–Ω–æ –≤ waiting
            let newStatus;
            switch(bus.status) {
                case 'waiting':
                    newStatus = 'boarding';
                    break;
                case 'boarding':
                    newStatus = 'departed';
                    break;
                case 'delayed':
                    newStatus = 'boarding';
                    break;
                case 'departed':
                    // Departed –æ—Å—Ç–∞–µ—Ç—Å—è departed
                    showNotification('–ö–µ—Ç–∫–µ–Ω —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—Ç—ã –∫–∞–π—Ä–∞ –±–∞—à–∫–∞—Ä—É—É–≥–∞ –±–æ–ª–±–æ–π—Ç!', 'warning');
                    return;
                default:
                    newStatus = 'waiting';
            }
            
            const oldStatus = bus.status;
            bus.status = newStatus;
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ departed, –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è
            if (newStatus === 'departed') {
                bus.departedTime = new Date();
            }
            
            // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ —Ä—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è
            bus.statusChanged = true;
            if (bus.announcements) {
                bus.announcements.statusManual = false;
            }
            
            addToHistory('status', bus, { oldStatus, newStatus: bus.status, manual: true });
            saveData();
            updateDisplay();
            showNotification(`${bus.route} —Å—Ç–∞—Ç—É—Å—É ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø: ${getStatusText(newStatus)}`);
        }

        function clearAll() {
            if (confirm('–ë–∞—Ä–¥—ã–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—Ç—ã ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?')) {
                buses.forEach(bus => {
                    database.deleted.push({
                        ...bus,
                        deletedAt: new Date(),
                        deletedBy: 'admin_clear_all'
                    });
                    addToHistory('delete', bus, { type: 'clear_all' });
                });
                buses = [];
                saveData();
                updateDisplay();
                showNotification('–ë–∞—Ä–¥—ã–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ”©—á“Ø—Ä“Ø–ª–¥“Ø');
            }
        }

        function clearForm() {
            document.getElementById('route').value = '';
            document.getElementById('time').value = '';
            document.getElementById('vehicle').value = 'bus';
            document.getElementById('seats').value = '';
            document.getElementById('available').value = '';
            document.getElementById('driver').value = '';
            document.getElementById('carrier').value = '';
            document.getElementById('price').value = '';
            document.getElementById('status').value = 'waiting';
            document.getElementById('bus-date').value = getTodayDate();
            setDefaultTime();
        }

        function updateDisplay() {
            updateStats();
            renderRoutes();
        }

        function getCurrentBuses() {
            const now = new Date();
            
            return buses.filter(bus => {
                // –ò—Å–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–±—É—Å—ã –∫–æ—Ç–æ—Ä—ã–µ –∏—Å—á–µ–∑–ª–∏ —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ (departed > 2 –º–∏–Ω—É—Ç)
                if (bus.status === 'departed' && bus.departedTime) {
                    const timeSinceDeparted = (now - new Date(bus.departedTime)) / (1000 * 60);
                    return timeSinceDeparted < 2; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω–µ–µ 2 –º–∏–Ω—É—Ç
                }
                return true; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
            });
        }

        function updateStats() {
            const currentBuses = getCurrentBuses();
            
            document.getElementById('total-count').textContent = currentBuses.length;
            document.getElementById('waiting-count').textContent = currentBuses.filter(b => b.status === 'waiting').length;
            document.getElementById('boarding-count').textContent = currentBuses.filter(b => b.status === 'boarding').length;
            document.getElementById('departed-count').textContent = currentBuses.filter(b => b.status === 'departed').length;
            
            const revenue = currentBuses.reduce((sum, bus) => {
                const occupiedSeats = bus.seats - (bus.available || 0);
                return sum + (occupiedSeats * (bus.price || 0));
            }, 0);
            
            document.getElementById('total-revenue').textContent = revenue.toLocaleString();
        }

        function renderRoutes() {
            const container = document.getElementById('routes-container');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–±—É—Å—ã "–≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç" (–Ω–µ —Ç–µ –∫–æ—Ç–æ—Ä—ã–µ –∏—Å—á–µ–∑–ª–∏ —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞)
            const currentBuses = getCurrentBuses();
            
            if (currentBuses.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">–£—á—É—Ä–¥–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∂–æ–∫</div>';
                return;
            }

            container.innerHTML = currentBuses.map(bus => `
                <div class="route-item">
                    <div class="route-field">${bus.route}</div>
                    <div class="route-field route-time">${bus.time}</div>
                    <div class="route-status status-${bus.status}">${getStatusText(bus.status)}</div>
                    <div class="route-field">${getVehicleText(bus.vehicle)}</div>
                    <div class="route-field">${bus.seats}</div>
                    <div class="route-field">${bus.available || 0}</div>
                    <div class="route-field">${bus.driver}</div>
                    <div class="route-field">${bus.carrier}</div>
                    <div class="route-field">${bus.price} —Å–æ–º</div>
                    <div class="route-actions">
                        <button class="btn btn-small btn-secondary" onclick="changeStatus(${bus.id})">üîÑ</button>
                        <button class="btn btn-small btn-danger" onclick="deleteBus(${bus.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const texts = {
                'waiting': '–ö“Ø—Ç“Ø“Ø–¥”©',
                'boarding': '–û—Ç—É—Ä–≥—É–∑—É—É',
                'delayed': '–ö–µ—á–∏–≥“Ø“Ø',
                'departed': '–ö–µ—Ç—Ç–∏'
            };
            return texts[status] || status;
        }

        function addToHistory(action, busData, details = {}) {
            const historyEntry = {
                id: Date.now(),
                timestamp: new Date(),
                action: action,
                bus: busData ? { ...busData } : null,
                details: details,
                dayId: currentDayId,
                user: currentUser ? currentUser.username : 'system'
            };
            database.history.push(historyEntry);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 1000 –∑–∞–ø–∏—Å—è–º–∏
            if (database.history.length > 1000) {
                database.history = database.history.slice(-1000);
            }
        }

        // –®–ê–ë–õ–û–ù–´
        function showCreateTemplateModal() {
            templateRouteCounter = 0;
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>–®–∞–±–ª–æ–Ω –∞—Ç—ã</label>
                        <input type="text" id="template-name" placeholder="–ñ–∞“£—ã —à–∞–±–ª–æ–Ω">
                    </div>
                    <div class="form-group">
                        <label>–°“Ø—Ä”©—Ç—Ç”©–º”©</label>
                        <textarea id="template-desc" placeholder="–®–∞–±–ª–æ–Ω –∂”©–Ω“Ø–Ω–¥”© –º–∞–∞–ª—ã–º–∞—Ç" rows="3"></textarea>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <h4 style="color: #3b82f6; margin-bottom: 15px;">–†–µ–π—Å—Ç–µ—Ä:</h4>
                    <div id="template-routes-container">
                        ${buses.length > 0 ? '<p style="color: #64748b; margin-bottom: 15px;">–£—á—É—Ä–¥–∞–≥—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—Ç–∞—Ä–¥–∞–Ω —à–∞–±–ª–æ–Ω —Ç“Ø–∑”© –∞–ª–∞—Å—ã–∑ –∂–µ –∂–∞“£—ã —Ä–µ–π—Å—Ç–µ—Ä–¥–∏ –∫–æ—à–æ –∞–ª–∞—Å—ã–∑</p>' : ''}
                    </div>
                    <button class="btn btn-small" onclick="addTemplateRoute()">‚ûï –†–µ–π—Å –∫–æ—à—É—É</button>
                </div>
                ${buses.length > 0 ? '<div style="margin-top: 15px;"><button class="btn btn-success btn-small" onclick="addCurrentBusesToTemplate()">üìã –£—á—É—Ä–¥–∞–≥—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—Ç–∞—Ä–¥—ã –∫–æ—à—É—É</button></div>' : ''}
            `;

            document.getElementById('modal-title').textContent = '–ñ–∞“£—ã —à–∞–±–ª–æ–Ω —Ç“Ø–∑“Ø“Ø';
            document.getElementById('modal-confirm').onclick = createTemplate;
            showModal();
        }

        function addTemplateRoute() {
            const container = document.getElementById('template-routes-container');
            const routeDiv = document.createElement('div');
            routeDiv.className = 'template-route-editor';
            routeDiv.id = `template-route-${templateRouteCounter}`;
            
            routeDiv.innerHTML = `
                <div>
                    <label>–ë–∞–≥—ã—Ç</label>
                    <input type="text" placeholder="–ë–∏—à–∫–µ–∫" id="route-${templateRouteCounter}">
                </div>
                <div>
                    <label>–£–±–∞–∫—ã—Ç</label>
                    <input type="time" id="time-${templateRouteCounter}">
                </div>
                <div>
                    <label>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</label>
                    <select id="vehicle-${templateRouteCounter}">
                        <option value="bus">–ê–≤—Ç–æ–±—É—Å</option>
                        <option value="minibus">–ú–∞—Ä—à—Ä—É—Ç–∫–∞</option>
                    </select>
                </div>
                <div>
                    <label>–û—Ä—É–Ω–¥–∞—Ä</label>
                    <input type="number" placeholder="45" id="seats-${templateRouteCounter}" min="10" max="80">
                </div>
                <div>
                    <label>–ê–π–¥–æ–æ—á—É</label>
                    <input type="text" placeholder="–≠–º–∏–ª–±–µ–∫ —É—É–ª—É" id="driver-${templateRouteCounter}">
                </div>
                <div>
                    <label>–¢–∞—à—É—É—á—É</label>
                    <input type="text" placeholder="–ö–∞—Ä–∞–∫–æ–ª –¢—Ä–∞–Ω—Å" id="carrier-${templateRouteCounter}">
                </div>
                <div>
                    <label>–ë–∞–∞—Å—ã</label>
                    <input type="number" placeholder="350" id="price-${templateRouteCounter}" min="50">
                </div>
                <div>
                    <button class="btn btn-small btn-danger" onclick="removeTemplateRoute(${templateRouteCounter})">üóëÔ∏è</button>
                </div>
            `;
            
            container.appendChild(routeDiv);
            templateRouteCounter++;
        }

        function addCurrentBusesToTemplate() {
            const container = document.getElementById('template-routes-container');
            
            buses.forEach((bus, index) => {
                const routeDiv = document.createElement('div');
                routeDiv.className = 'template-route-editor';
                routeDiv.id = `template-route-${templateRouteCounter}`;
                
                routeDiv.innerHTML = `
                    <div>
                        <label>–ë–∞–≥—ã—Ç</label>
                        <input type="text" value="${bus.route}" id="route-${templateRouteCounter}">
                    </div>
                    <div>
                        <label>–£–±–∞–∫—ã—Ç</label>
                        <input type="time" value="${bus.time}" id="time-${templateRouteCounter}">
                    </div>
                    <div>
                        <label>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</label>
                        <select id="vehicle-${templateRouteCounter}">
                            <option value="bus" ${(bus.vehicle || 'bus') === 'bus' ? 'selected' : ''}>–ê–≤—Ç–æ–±—É—Å</option>
                            <option value="minibus" ${bus.vehicle === 'minibus' ? 'selected' : ''}>–ú–∞—Ä—à—Ä—É—Ç–∫–∞</option>
                        </select>
                    </div>
                    <div>
                        <label>–û—Ä—É–Ω–¥–∞—Ä</label>
                        <input type="number" value="${bus.seats}" id="seats-${templateRouteCounter}" min="10" max="80">
                    </div>
                    <div>
                        <label>–ê–π–¥–æ–æ—á—É</label>
                        <input type="text" value="${bus.driver}" id="driver-${templateRouteCounter}">
                    </div>
                    <div>
                        <label>–¢–∞—à—É—É—á—É</label>
                        <input type="text" value="${bus.carrier}" id="carrier-${templateRouteCounter}">
                    </div>
                    <div>
                        <label>–ë–∞–∞—Å—ã</label>
                        <input type="number" value="${bus.price}" id="price-${templateRouteCounter}" min="50">
                    </div>
                    <div>
                        <button class="btn btn-small btn-danger" onclick="removeTemplateRoute(${templateRouteCounter})">üóëÔ∏è</button>
                    </div>
                `;
                
                container.appendChild(routeDiv);
                templateRouteCounter++;
            });
            
            showNotification('–£—á—É—Ä–¥–∞–≥—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—Ç–∞—Ä —à–∞–±–ª–æ–Ω–≥–æ –∫–æ—à—É–ª–¥—É!');
        }

        function removeTemplateRoute(index) {
            const routeDiv = document.getElementById(`template-route-${index}`);
            if (routeDiv) {
                routeDiv.remove();
            }
        }

        function createTemplate() {
            const name = document.getElementById('template-name').value.trim();
            const desc = document.getElementById('template-desc').value.trim();

            if (!name) {
                showNotification('–®–∞–±–ª–æ–Ω –∞—Ç—ã–Ω –∂–∞–∑—ã“£—ã–∑!', 'error');
                return;
            }

            let routes = [];
            
            for (let i = 0; i < templateRouteCounter; i++) {
                const routeInput = document.getElementById(`route-${i}`);
                const timeInput = document.getElementById(`time-${i}`);
                const vehicleInput = document.getElementById(`vehicle-${i}`);
                const seatsInput = document.getElementById(`seats-${i}`);
                const driverInput = document.getElementById(`driver-${i}`);
                const carrierInput = document.getElementById(`carrier-${i}`);
                const priceInput = document.getElementById(`price-${i}`);
                
                if (routeInput && timeInput && vehicleInput && seatsInput && driverInput && carrierInput && priceInput && 
                    routeInput.value.trim() && timeInput.value && seatsInput.value && driverInput.value.trim() && 
                    carrierInput.value.trim() && priceInput.value) {
                    routes.push({
                        route: routeInput.value.trim(),
                        time: timeInput.value,
                        vehicle: vehicleInput.value,
                        seats: parseInt(seatsInput.value) || 40,
                        available: parseInt(seatsInput.value) || 40,
                        driver: driverInput.value.trim(),
                        carrier: carrierInput.value.trim(),
                        price: parseInt(priceInput.value) || 100
                    });
                }
            }

            if (routes.length === 0) {
                showNotification('–®–∞–±–ª–æ–Ω “Ø—á“Ø–Ω —Ä–µ–π—Å—Ç–µ—Ä –∫–æ—à—É“£—É–∑!', 'error');
                return;
            }

            const templateKey = Date.now().toString();
            const template = {
                name: name,
                description: desc || '–ö–æ–ª–¥–æ–Ω—É—É—á—É —à–∞–±–ª–æ–Ω—É',
                routes: routes,
                created: new Date()
            };

            database.templates[templateKey] = template;
            saveData();
            renderTemplates();
            closeModal();
            showNotification(`${name} —à–∞–±–ª–æ–Ω—É —Å–∞–∫—Ç–∞–ª–¥—ã!`);
        }

        function renderTemplates() {
            const container = document.getElementById('templates-container');
            
            container.innerHTML = Object.entries(database.templates).map(([key, template]) => `
                <div class="template-card" onclick="applyTemplate('${key}')">
                    <div class="template-title">${template.name}</div>
                    <div class="template-desc">${template.description}</div>
                    <div class="template-routes">
                        ${template.routes.map(route => `
                            <div class="template-route">
                                <span>${route.route}</span>
                                <span>${route.time}</span>
                                <span>${getVehicleText(route.vehicle || 'bus')}</span>
                                <span>${route.price} —Å–æ–º</span>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteTemplate('${key}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function applyTemplate(templateKey) {
            if (!dayStarted) {
                showNotification('–ê–ª–≥–∞—á –∫“Ø–Ω–¥“Ø –±–∞—à–∞—Ç—ã“£—ã–∑!', 'error');
                return;
            }

            const template = database.templates[templateKey];
            if (!template) return;

            let added = 0;
            template.routes.forEach((routeData, index) => {
                setTimeout(() => {
                    const newBus = {
                        id: busCounter++,
                        ...routeData,
                        vehicle: routeData.vehicle || 'bus',
                        available: routeData.available || routeData.seats,
                        status: 'waiting',
                        date: getTodayDate(),
                        created: new Date(),
                        dayId: currentDayId,
                        announcements: {
                            fiveMinutes: false,
                            boarding: false,
                            departed: false
                        }
                    };

                    buses.push(newBus);
                    addToHistory('add', newBus, { template: templateKey });
                    added++;

                    if (added === template.routes.length) {
                        saveData();
                        updateDisplay();
                        showNotification(`${template.name} —à–∞–±–ª–æ–Ω—É –∫–æ–ª–¥–æ–Ω—É–ª–¥—É! ${added} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∫–æ—à—É–ª–¥—É`);
                    }
                }, index * 100);
            });
        }

        function deleteTemplate(templateKey) {
            const template = database.templates[templateKey];
            if (!template) return;

            if (confirm(`${template.name} —à–∞–±–ª–æ–Ω—É–Ω ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?`)) {
                delete database.templates[templateKey];
                saveData();
                renderTemplates();
                showNotification('–®–∞–±–ª–æ–Ω ”©—á“Ø—Ä“Ø–ª–¥“Ø');
            }
        }

        function updateAllStatuses(newStatus) {
            if (buses.length === 0) {
                showNotification('–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∂–æ–∫!', 'error');
                return;
            }

            const currentBuses = getCurrentBuses();
            currentBuses.forEach(bus => {
                const oldStatus = bus.status;
                bus.status = newStatus;
                if (newStatus === 'departed') {
                    bus.departedTime = new Date();
                }
                addToHistory('status', bus, { oldStatus, newStatus, type: 'bulk' });
            });

            saveData();
            updateDisplay();
            showNotification(`–ë–∞—Ä–¥—ã–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—Ç—É–Ω —Å—Ç–∞—Ç—É—Å—É "${getStatusText(newStatus)}" –±–æ–ª—É–ø ”©–∑–≥”©—Ä–¥“Ø`);
        }

        // –ò–ú–ü–û–†–¢/–≠–ö–°–ü–û–†–¢
        function importFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.csv';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        if (file.name.endsWith('.json')) {
                            const data = JSON.parse(e.target.result);
                            if (data.buses && Array.isArray(data.buses)) {
                                data.buses.forEach(bus => {
                                    buses.push({
                                        ...bus,
                                        id: busCounter++,
                                        created: new Date(),
                                        dayId: currentDayId,
                                        vehicle: bus.vehicle || 'bus',
                                        available: bus.available || bus.seats
                                    });
                                });
                                saveData();
                                updateDisplay();
                                showNotification(`${data.buses.length} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏–º–ø–æ—Ä—Ç –±–æ–ª–¥—É!`);
                            }
                        }
                    } catch (error) {
                        showNotification('–§–∞–π–ª –æ–∫—É—É–¥–∞ –∫–∞—Ç–∞!', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportToFile() {
            const data = {
                buses: buses,
                templates: database.templates,
                days: database.days,
                exported: new Date(),
                version: '3.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `karakol-backup-${getTodayDate()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä —ç–∫—Å–ø–æ—Ä—Ç –±–æ–ª–¥—É!');
        }

        // –ò–°–¢–û–†–ò–Ø
        function loadHistory() {
            const selectedDate = document.getElementById('history-date').value;
            const filterType = document.getElementById('history-filter').value;
            const container = document.getElementById('history-container');

            if (!selectedDate) {
                showNotification('–ö“Ø–Ω“Ø–Ω —Ç–∞–Ω–¥–∞“£—ã–∑!', 'error');
                return;
            }

            const selectedDateObj = new Date(selectedDate);
            selectedDateObj.setHours(0, 0, 0, 0);
            const nextDay = new Date(selectedDateObj);
            nextDay.setDate(nextDay.getDate() + 1);

            let filteredHistory = database.history.filter(entry => {
                const entryDate = new Date(entry.timestamp);
                return entryDate >= selectedDateObj && entryDate < nextDay;
            });

            if (filterType) {
                filteredHistory = filteredHistory.filter(entry => entry.action === filterType);
            }

            if (filteredHistory.length === 0) {
                container.innerHTML = `
                    <div class="history-list">
                        <div class="history-item">
                            <div class="history-action" style="text-align: center; color: #6b7280;">
                                –¢–∞–Ω–¥–∞–ª–≥–∞–Ω –∫“Ø–Ω“Ø “Ø—á“Ø–Ω —Ç–∞—Ä—ã—Ö —Ç–∞–±—ã–ª–≥–∞–Ω –∂–æ–∫
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            filteredHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const historyHtml = filteredHistory.map(entry => {
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                const actionText = getActionText(entry.action);
                const busInfo = entry.bus ? `${entry.bus.route} (${getVehicleText(entry.bus.vehicle)})` : '';
                const userInfo = entry.user ? ` [${entry.user}]` : '';
                
                return `
                    <div class="history-item">
                        <div class="history-timestamp">${timeStr}${userInfo}</div>
                        <div class="history-action">${actionText} ${busInfo}</div>
                        <div class="history-details">${getHistoryDetails(entry)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="history-list">
                    ${historyHtml}
                </div>
            `;

            showNotification(`${filteredHistory.length} —Ç–∞—Ä—ã—Ö –∂–∞–∑—É—É—Å—É –∂“Ø–∫—Ç”©–ª–¥“Ø`);
        }

        function getActionText(action) {
            const texts = {
                'add': '‚ûï –ö–æ—à—É–ª–¥—É',
                'edit': '‚úèÔ∏è ”®–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø',
                'delete': 'üóëÔ∏è ”®—á“Ø—Ä“Ø–ª–¥“Ø',
                'status': 'üîÑ –°—Ç–∞—Ç—É—Å ”©–∑–≥”©—Ä–¥“Ø',
                'day_start': 'üåÖ –ö“Ø–Ω –±–∞—à—Ç–∞–ª–¥—ã',
                'day_end': 'üåô –ö“Ø–Ω –∞—è–∫—Ç–∞–¥—ã',
                'password_change': 'üîê –ü–∞—Ä–æ–ª–¥–æ—Ä ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø'
            };
            return texts[action] || action;
        }

        function getHistoryDetails(entry) {
            if (entry.details && entry.details.oldStatus && entry.details.newStatus) {
                return `${getStatusText(entry.details.oldStatus)} ‚Üí ${getStatusText(entry.details.newStatus)}`;
            }
            if (entry.details && entry.details.type === 'clear_all') {
                return '–ú–∞—Å—Å–∞–ª—ã–∫ ”©—á“Ø—Ä“Ø“Ø';
            }
            if (entry.details && entry.details.dayId) {
                return `–ö“Ø–Ω ID: ${entry.details.dayId}`;
            }
            if (entry.action === 'password_change' && entry.details) {
                let details = [];
                if (entry.details.adminChanged) details.push('–∞–¥–º–∏–Ω');
                if (entry.details.operatorChanged) details.push('–æ–ø–µ—Ä–∞—Ç–æ—Ä');
                return `”®–∑–≥”©—Ä—Ç“Ø–ª–≥”©–Ω: ${details.join(', ')}`;
            }
            return '';
        }

        // –û–¢–ß–ï–¢–´
        function generateReport() {
            const selectedDate = document.getElementById('report-date').value;
            const reportType = document.getElementById('report-type').value;
            const container = document.getElementById('report-container');

            if (!selectedDate) {
                showNotification('–ö“Ø–Ω“Ø–Ω —Ç–∞–Ω–¥–∞“£—ã–∑!', 'error');
                return;
            }

            const reportData = calculateReportData(selectedDate, reportType);
            
            container.innerHTML = `
                <div class="report-container">
                    <div class="report-section">
                        <div class="report-title">${getReportTitle(reportType)} –æ—Ç—á–µ—Ç - ${selectedDate}</div>
                        <div class="report-stats">
                            <div class="report-stat">
                                <div class="report-stat-value">${reportData.totalBuses}</div>
                                <div class="report-stat-label">–ñ–∞–ª–ø—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</div>
                            </div>
                            <div class="report-stat">
                                <div class="report-stat-value">${reportData.departedBuses}</div>
                                <div class="report-stat-label">–ö–µ—Ç–∫–µ–Ω —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</div>
                            </div>
                            <div class="report-stat">
                                <div class="report-stat-value">${reportData.totalRevenue.toLocaleString()}</div>
                                <div class="report-stat-label">–ö–∏—Ä–µ—à–µ (—Å–æ–º)</div>
                            </div>
                            <div class="report-stat">
                                <div class="report-stat-value">${reportData.totalPassengers}</div>
                                <div class="report-stat-label">–ñ–æ–ª–æ–æ—á—É–ª–∞—Ä</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-section">
                        <div class="report-title">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                        <div style="background: #374151; padding: 15px; border-radius: 6px;">
                            ${reportData.busesData.length > 0 ? `
                                <table style="width: 100%; color: white;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid #6b7280;">
                                            <th style="text-align: left; padding: 8px;">–ë–∞–≥—ã—Ç</th>
                                            <th style="text-align: left; padding: 8px;">–£–±–∞–∫—ã—Ç</th>
                                            <th style="text-align: left; padding: 8px;">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</th>
                                            <th style="text-align: left; padding: 8px;">–û—Ä—É–Ω–¥–∞—Ä</th>
                                            <th style="text-align: left; padding: 8px;">–ê–π–¥–æ–æ—á—É</th>
                                            <th style="text-align: left; padding: 8px;">–ë–∞–∞—Å—ã</th>
                                            <th style="text-align: left; padding: 8px;">–°—Ç–∞—Ç—É—Å</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${reportData.busesData.map(bus => `
                                            <tr style="border-bottom: 1px solid #4b5563;">
                                                <td style="padding: 8px;">${bus.route}</td>
                                                <td style="padding: 8px;">${bus.time}</td>
                                                <td style="padding: 8px;">${getVehicleText(bus.vehicle)}</td>
                                                <td style="padding: 8px;">${bus.seats}</td>
                                                <td style="padding: 8px;">${bus.driver}</td>
                                                <td style="padding: 8px;">${bus.price} —Å–æ–º</td>
                                                <td style="padding: 8px;">${getStatusText(bus.status)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="color: #9ca3af; text-align: center;">–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –∂–æ–∫</p>'}
                        </div>
                    </div>
                    
                    ${reportData.popularRoutes.length > 0 ? `
                        <div class="report-section">
                            <div class="report-title">–ü–æ–ø—É–ª—è—Ä–¥—É—É –±–∞–≥—ã—Ç—Ç–∞—Ä</div>
                            <div style="background: #374151; padding: 15px; border-radius: 6px;">
                                ${reportData.popularRoutes.map(route => `
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: white;">
                                        <span>${route.route}</span>
                                        <span>${route.count} —Ä–µ–π—Å</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            showNotification('–û—Ç—á–µ—Ç —Ç“Ø–∑“Ø–ª–¥“Ø!');
        }

        function calculateReportData(selectedDate, reportType) {
            const filteredBuses = buses.filter(bus => {
                if (bus.date) {
                    return bus.date === selectedDate;
                }
                if (bus.created) {
                    const createdDate = new Date(bus.created).toISOString().split('T')[0];
                    return createdDate === selectedDate;
                }
                return false;
            });

            const historyBuses = database.history
                .filter(entry => {
                    const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                    return entryDate === selectedDate && entry.action === 'add' && entry.bus;
                })
                .map(entry => entry.bus);

            const allBuses = [...filteredBuses];
            historyBuses.forEach(historyBus => {
                if (!allBuses.find(bus => bus.id === historyBus.id)) {
                    allBuses.push(historyBus);
                }
            });

            const routeStats = {};
            let totalRevenue = 0;
            let totalPassengers = 0;

            allBuses.forEach(bus => {
                const route = bus.route;
                routeStats[route] = (routeStats[route] || 0) + 1;
                
                const occupiedSeats = bus.seats - (bus.available || 0);
                totalPassengers += occupiedSeats;
                totalRevenue += occupiedSeats * (bus.price || 0);
            });

            const popularRoutes = Object.entries(routeStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([route, count]) => ({ route, count }));

            return {
                totalBuses: allBuses.length,
                departedBuses: allBuses.filter(bus => bus.status === 'departed').length,
                totalRevenue,
                totalPassengers,
                popularRoutes,
                busesData: allBuses
            };
        }

        function getReportTitle(reportType) {
            const titles = {
                'daily': '–ö“Ø–Ω–¥“Ø–∫',
                'weekly': '–ñ—É–º–∞–ª—ã–∫',
                'monthly': '–ê–π–ª—ã–∫'
            };
            return titles[reportType] || '–ö“Ø–Ω–¥“Ø–∫';
        }

        function exportToText() {
            if (buses.length === 0) {
                showNotification('–≠–∫—Å–ø–æ—Ä—Ç “Ø—á“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –∂–æ–∫!', 'error');
                return;
            }

            try {
                let reportText = '';
                reportText += '=== –ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò - –û–¢–ß–ï–¢ ===\n\n';
                reportText += `–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}\n`;
                reportText += `–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${buses.length}\n`;
                reportText += `–û–∂–∏–¥–∞—é—Ç: ${buses.filter(b => b.status === 'waiting').length}\n`;
                reportText += `–ü–æ—Å–∞–¥–∫–∞: ${buses.filter(b => b.status === 'boarding').length}\n`;
                reportText += `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã: ${buses.filter(b => b.status === 'departed').length}\n`;
                reportText += `–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: ${calculateTotalRevenue().toLocaleString()} —Å–æ–º\n\n`;
                
                reportText += '=== –î–ï–¢–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===\n\n';
                reportText += '–ë–∞–≥—ã—Ç'.padEnd(15) + '–£–±–∞–∫—ã—Ç'.padEnd(10) + '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç'.padEnd(12) + '–û—Ä—É–Ω–¥–∞—Ä'.padEnd(10) + '–ê–π–¥–æ–æ—á—É'.padEnd(15) + '–¢–∞—à—É—É—á—É'.padEnd(20) + '–ë–∞–∞—Å—ã'.padEnd(10) + '–°—Ç–∞—Ç—É—Å\n';
                reportText += '='.repeat(100) + '\n';
                
                buses.forEach(bus => {
                    reportText += bus.route.padEnd(15);
                    reportText += bus.time.padEnd(10);
                    reportText += getVehicleText(bus.vehicle).padEnd(12);
                    reportText += bus.seats.toString().padEnd(10);
                    reportText += bus.driver.padEnd(15);
                    reportText += bus.carrier.padEnd(20);
                    reportText += (bus.price + ' —Å–æ–º').padEnd(10);
                    reportText += getStatusText(bus.status);
                    reportText += '\n';
                });
                
                const routeStats = {};
                buses.forEach(bus => {
                    const route = bus.route;
                    if (routeStats[route]) {
                        routeStats[route]++;
                    } else {
                        routeStats[route] = 1;
                    }
                });
                
                reportText += '\n=== –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ú–ê–†–®–†–£–¢–ê–ú ===\n\n';
                Object.entries(routeStats)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([route, count]) => {
                        reportText += `${route}: ${count} —Ä–µ–π—Å–æ–≤\n`;
                    });
                
                const blob = new Blob([reportText], { type: 'text/plain; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `karakol-report-${getTodayDate()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç —Å–∞–∫—Ç–∞–ª–¥—ã!');
            } catch (error) {
                console.error('Text export error:', error);
                showNotification('–¢–µ–∫—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç—Ç–æ–æ–¥–æ –∫–∞—Ç–∞!', 'error');
            }
        }

        function exportToExcel() {
            if (buses.length === 0) {
                showNotification('–≠–∫—Å–ø–æ—Ä—Ç “Ø—á“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –∂–æ–∫!', 'error');
                return;
            }

            try {
                const workbook = XLSX.utils.book_new();
                
                const reportData = [];
                reportData.push(['–ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò - –û–¢–ß–ï–¢']);
                reportData.push([]);
                reportData.push(['–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:', new Date().toLocaleDateString('ru-RU')]);
                reportData.push(['–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:', buses.length]);
                reportData.push(['–û–∂–∏–¥–∞—é—Ç:', buses.filter(b => b.status === 'waiting').length]);
                reportData.push(['–ü–æ—Å–∞–¥–∫–∞:', buses.filter(b => b.status === 'boarding').length]);
                reportData.push(['–û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã:', buses.filter(b => b.status === 'departed').length]);
                reportData.push(['–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ (—Å–æ–º):', calculateTotalRevenue()]);
                reportData.push([]);
                reportData.push(['–î–ï–¢–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:']);
                reportData.push(['–ë–∞–≥—ã—Ç', '–£–±–∞–∫—ã—Ç', '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '–û—Ä—É–Ω–¥–∞—Ä', '–ë–æ—à –æ—Ä—É–Ω–¥–∞—Ä', '–ê–π–¥–æ–æ—á—É', '–¢–∞—à—É—É—á—É', '–ë–∞–∞—Å—ã (—Å–æ–º)', '–°—Ç–∞—Ç—É—Å']);
                
                buses.forEach(bus => {
                    reportData.push([
                        bus.route,
                        bus.time,
                        getVehicleText(bus.vehicle),
                        bus.seats,
                        bus.available || 0,
                        bus.driver,
                        bus.carrier,
                        bus.price,
                        getStatusText(bus.status)
                    ]);
                });

                const worksheet = XLSX.utils.aoa_to_sheet(reportData);
                worksheet['!cols'] = [
                    {wch: 15}, {wch: 10}, {wch: 12}, {wch: 8}, {wch: 12}, 
                    {wch: 15}, {wch: 18}, {wch: 12}, {wch: 12}
                ];
                
                XLSX.utils.book_append_sheet(workbook, worksheet, "–û—Ç—á–µ—Ç");
                
                const routeStats = {};
                buses.forEach(bus => {
                    const route = bus.route;
                    if (routeStats[route]) {
                        routeStats[route].count++;
                        routeStats[route].revenue += (bus.seats - (bus.available || 0)) * (bus.price || 0);
                    } else {
                        routeStats[route] = {
                            count: 1,
                            revenue: (bus.seats - (bus.available || 0)) * (bus.price || 0)
                        };
                    }
                });

                const statsData = [];
                statsData.push(['–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ú–ê–†–®–†–£–¢–ê–ú']);
                statsData.push([]);
                statsData.push(['–ú–∞—Ä—à—Ä—É—Ç', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–π—Å–æ–≤', '–í—ã—Ä—É—á–∫–∞ (—Å–æ–º)']);
                
                Object.entries(routeStats).forEach(([route, stats]) => {
                    statsData.push([route, stats.count, stats.revenue]);
                });

                const statsWorksheet = XLSX.utils.aoa_to_sheet(statsData);
                statsWorksheet['!cols'] = [{wch: 20}, {wch: 18}, {wch: 15}];
                XLSX.utils.book_append_sheet(workbook, statsWorksheet, "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞");
                
                XLSX.writeFile(workbook, `karakol-report-${getTodayDate()}.xlsx`);
                showNotification('Excel –æ—Ç—á–µ—Ç —Å–∞–∫—Ç–∞–ª–¥—ã!');
            } catch (error) {
                console.error('Excel –∫–∞—Ç–∞:', error);
                showNotification('Excel —Ç“Ø–∑“Ø“Ø–¥”© –∫–∞—Ç–∞!', 'error');
            }
        }

        // –ù–ê–°–¢–†–û–ô–ö–ò
        function saveSettings() {
            const updateInterval = document.getElementById('update-interval').value;
            const volume = document.getElementById('volume').value;
            const autoRemove = document.getElementById('auto-remove').value;
            const announcementInterval = document.getElementById('announcement-interval').value;

            const settings = {
                updateInterval: parseInt(updateInterval),
                volume: parseFloat(volume),
                autoRemove: parseInt(autoRemove),
                announcementInterval: parseInt(announcementInterval),
                saved: new Date()
            };

            localStorage.setItem('karakol-settings', JSON.stringify(settings));
            showNotification('–ñ”©–Ω–¥”©”©–ª”©—Ä —Å–∞–∫—Ç–∞–ª–¥—ã!');
        }

        function testAnnouncement() {
            const text = '–ë–∏—à–∫–µ–∫ –±–∞–≥—ã—Ç—ã–Ω–∞ –∞–≤—Ç–æ–±—É—Å 5 –º“Ø–Ω”©—Ç—Ç”©–Ω –∫–∏–π–∏–Ω –∫–µ—Ç–µ—Ç. –ñ–æ–ª–æ–æ—á—É–ª–∞—Ä –¥–∞—è—Ä–¥–∞–Ω—ã“£—ã–∑.';
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ru-RU';
                utterance.rate = 0.75;
                utterance.pitch = 1.0;
                utterance.volume = parseFloat(document.getElementById('volume').value) || 0.8;
                
                speechSynthesis.speak(utterance);
                showNotification('–î–æ–±—É—à —Ç–µ—Å—Ç–∏ –±–∞—à—Ç–∞–ª–¥—ã!');
            } else {
                showNotification('–î–æ–±—É—à —Ç–µ—Å—Ç–∏ –∫–æ–ª–¥–æ–æ–≥–æ –∞–ª—ã–Ω–±–∞–π—Ç!', 'error');
            }
        }

        function showCurrentUsers() {
            const users = getUsers();
            const modalBody = document.getElementById('modal-body');
            
            modalBody.innerHTML = `
                <div style="background: #374151; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #3b82f6; margin-bottom: 15px;">–£—á—É—Ä–¥–∞–≥—ã –∫–æ–ª–¥–æ–Ω—É—É—á—É–ª–∞—Ä:</h4>
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #22c55e;">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (admin)</strong><br>
                        <span style="color: #94a3b8;">–†–æ–ª—å: ${users.admin.role}</span><br>
                        <span style="color: #94a3b8;">–ê—Ç—ã: ${users.admin.name}</span><br>
                        <span style="color: #fbbf24;">–ü–∞—Ä–æ–ª—å: ${'*'.repeat(users.admin.password.length)} (${users.admin.password.length} —Å–∏–º–≤–æ–ª)</span>
                    </div>
                    <div>
                        <strong style="color: #60a5fa;">üë§ –û–ø–µ—Ä–∞—Ç–æ—Ä (operator)</strong><br>
                        <span style="color: #94a3b8;">–†–æ–ª—å: ${users.operator.role}</span><br>
                        <span style="color: #94a3b8;">–ê—Ç—ã: ${users.operator.name}</span><br>
                        <span style="color: #fbbf24;">–ü–∞—Ä–æ–ª—å: ${'*'.repeat(users.operator.password.length)} (${users.operator.password.length} —Å–∏–º–≤–æ–ª)</span>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(251, 191, 36, 0.1); border-radius: 6px; border-left: 4px solid #fbbf24;">
                    <small style="color: #fbbf24;">‚ö†Ô∏è –ü–∞—Ä–æ–ª–¥–æ—Ä–¥—É ”©–∑–≥”©—Ä—Ç“Ø“Ø–¥”©–Ω –∫–∏–π–∏–Ω —Å–∏—Å—Ç–µ–º–∞–¥–∞–Ω —á—ã–≥—ã–ø, –∂–∞“£—ã –ø–∞—Ä–æ–ª—å –º–µ–Ω–µ–Ω –∫–∏—Ä–∏“£–∏–∑.</small>
                </div>
            `;

            document.getElementById('modal-title').textContent = '–ö–æ–ª–¥–æ–Ω—É—É—á—É–ª–∞—Ä –º–∞–∞–ª—ã–º–∞—Ç—ã';
            document.getElementById('modal-confirm').style.display = 'none';
            showModal();
        }

        function changePasswords() {
            const adminPassword = document.getElementById('admin-password').value.trim();
            const adminPasswordConfirm = document.getElementById('admin-password-confirm').value.trim();
            const operatorPassword = document.getElementById('operator-password').value.trim();
            const operatorPasswordConfirm = document.getElementById('operator-password-confirm').value.trim();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–æ–ª—å –≤–≤–µ–¥–µ–Ω
            if (!adminPassword && !operatorPassword) {
                showNotification('–ö–µ–º–∏–Ω–¥–µ –±–∏—Ä –ø–∞—Ä–æ–ª—å–¥—É –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑!', 'error');
                return;
            }

            const users = getUsers();
            let changed = false;

            // –ò–∑–º–µ–Ω—è–µ–º –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞
            if (adminPassword) {
                if (adminPassword.length < 6) {
                    showNotification('–ê–¥–º–∏–Ω –ø–∞—Ä–æ–ª—å –∫–µ–º–∏–Ω–¥–µ 6 —Å–∏–º–≤–æ–ª–¥–æ–Ω —Ç—É—Ä—É—à—É –∫–µ—Ä–µ–∫!', 'error');
                    return;
                }
                
                if (adminPassword !== adminPasswordConfirm) {
                    showNotification('–ê–¥–º–∏–Ω –ø–∞—Ä–æ–ª–¥–æ—Ä –¥–∞–ª –∫–µ–ª–±–µ–π—Ç!', 'error');
                    return;
                }

                users.admin.password = adminPassword;
                changed = true;
            }

            // –ò–∑–º–µ–Ω—è–µ–º –ø–∞—Ä–æ–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
            if (operatorPassword) {
                if (operatorPassword.length < 6) {
                    showNotification('–û–ø–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª—å –∫–µ–º–∏–Ω–¥–µ 6 —Å–∏–º–≤–æ–ª–¥–æ–Ω —Ç—É—Ä—É—à—É –∫–µ—Ä–µ–∫!', 'error');
                    return;
                }
                
                if (operatorPassword !== operatorPasswordConfirm) {
                    showNotification('–û–ø–µ—Ä–∞—Ç–æ—Ä –ø–∞—Ä–æ–ª–¥–æ—Ä –¥–∞–ª –∫–µ–ª–±–µ–π—Ç!', 'error');
                    return;
                }

                users.operator.password = operatorPassword;
                changed = true;
            }

            if (changed) {
                localStorage.setItem('karakol-users', JSON.stringify(users));
                addToHistory('password_change', null, { 
                    adminChanged: !!adminPassword, 
                    operatorChanged: !!operatorPassword 
                });
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-password-confirm').value = '';
                document.getElementById('operator-password').value = '';
                document.getElementById('operator-password-confirm').value = '';
                
                showNotification('–ü–∞—Ä–æ–ª–¥–æ—Ä –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø! üîê');
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    if (confirm('–ö–æ–æ–ø—Å—É–∑–¥—É–∫ “Ø—á“Ø–Ω —Å–∏—Å—Ç–µ–º–∞–¥–∞–Ω —á—ã–≥—ã–ø, –∂–∞“£—ã –ø–∞—Ä–æ–ª—å –º–µ–Ω–µ–Ω –∫–∏—Ä–∏“£–∏–∑.')) {
                        logout();
                    }
                }, 3000);
            }
        }

        function resetSystem() {
            if (confirm('–°–∏—Å—Ç–µ–º–∞–Ω—ã –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä–µ—Å–∏–∑–±–∏? –ë–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä ”©—á”©—Ç!')) {
                localStorage.removeItem('karakol-bus-station-display');
                localStorage.removeItem('karakol-bus-station-admin');
                localStorage.removeItem('karakol-bus-station-db');
                localStorage.removeItem('karakol-settings');
                
                buses = [];
                busCounter = 1;
                dayStarted = false;
                currentDayId = null;
                database = {
                    buses: [],
                    deleted: [],
                    history: [],
                    templates: {},
                    days: []
                };
                
                updateDisplay();
                updateDayStatus();
                renderTemplates();
                showNotification('–°–∏—Å—Ç–µ–º–∞ –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä–∏–ª–¥–∏!');
            }
        }

        // –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê
        function showModal() {
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        function confirmModal() {
            // Placeholder function
        }

        // –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
        function saveData() {
            try {
                // –î–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∞–≤—Ç–æ–±—É—Å—ã –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è
                const displayData = {
                    buses: getCurrentBuses(), // –¢–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞–≤—Ç–æ–±—É—Å—ã
                    busCounter: busCounter,
                    dayStarted: dayStarted,
                    currentDayId: currentDayId,
                    lastUpdate: new Date().toISOString()
                };
                
                // –î–ª—è –∞–¥–º–∏–Ω–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∞–≤—Ç–æ–±—É—Å—ã (–ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è)
                const adminData = {
                    buses: buses, // –í—Å–µ –∞–≤—Ç–æ–±—É—Å—ã –≤–∫–ª—é—á–∞—è –∏—Å—á–µ–∑–Ω—É–≤—à–∏–µ
                    busCounter: busCounter,
                    dayStarted: dayStarted,
                    currentDayId: currentDayId,
                    lastUpdate: new Date().toISOString()
                };
                
                localStorage.setItem('karakol-bus-station-display', JSON.stringify(displayData));
                localStorage.setItem('karakol-bus-station-admin', JSON.stringify(adminData));
                localStorage.setItem('karakol-bus-station-db', JSON.stringify(database));
                
                console.log('üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showNotification('–°–∞–∫—Ç–æ–æ–¥–æ –∫–∞—Ç–∞!', 'error');
            }
        }

        function loadData() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ (–≤—Å–µ –∞–≤—Ç–æ–±—É—Å—ã)
                const adminSaved = JSON.parse(localStorage.getItem('karakol-bus-station-admin') || '{}');
                const displaySaved = JSON.parse(localStorage.getItem('karakol-bus-station-display') || '{}');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω—ã–µ
                const saved = Object.keys(adminSaved).length > 0 ? adminSaved : displaySaved;
                
                buses = saved.buses || [];
                busCounter = saved.busCounter || 1;
                dayStarted = saved.dayStarted || false;
                currentDayId = saved.currentDayId || null;
                
                const savedDb = JSON.parse(localStorage.getItem('karakol-bus-station-db') || '{}');
                database = { 
                    buses: [],
                    deleted: [],
                    history: [],
                    templates: {},
                    days: [],
                    ...savedDb 
                };
                
                updateDisplay();
                updateDayStatus();
                renderTemplates();
                
                console.log('üìã –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –∞–¥–º–∏–Ω–∫—É');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showNotification('–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞!', 'error');
            }
        }

        function loadSettings() {
            try {
                const savedSettings = JSON.parse(localStorage.getItem('karakol-settings') || '{}');
                
                if (savedSettings.updateInterval) document.getElementById('update-interval').value = savedSettings.updateInterval;
                if (savedSettings.volume) {
                    document.getElementById('volume').value = savedSettings.volume;
                    const volumeDisplay = document.getElementById('volume-display');
                    if (volumeDisplay) {
                        volumeDisplay.textContent = Math.round(savedSettings.volume * 100) + '%';
                    }
                }
                if (savedSettings.autoRemove) document.getElementById('auto-remove').value = savedSettings.autoRemove;
                if (savedSettings.announcementInterval) document.getElementById('announcement-interval').value = savedSettings.announcementInterval;
                
                console.log('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        }

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        function init() {
            document.getElementById('bus-date').value = getTodayDate();
            document.getElementById('bus-date').min = getTodayDate();
            document.getElementById('history-date').value = getTodayDate();
            document.getElementById('report-date').value = getTodayDate();
            
            loadData();
            setDefaultTime();
            initDefaultTemplates();
            loadSettings();
            
            const seatsInput = document.getElementById('seats');
            const availableInput = document.getElementById('available');
            
            seatsInput.addEventListener('input', function() {
                if (this.value && !availableInput.value) {
                    availableInput.value = this.value;
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            const volumeSlider = document.getElementById('volume');
            const volumeDisplay = document.getElementById('volume-display');
            
            if (volumeSlider && volumeDisplay) {
                volumeSlider.addEventListener('input', function() {
                    volumeDisplay.textContent = Math.round(this.value * 100) + '%';
                });
            }
            
            setInterval(() => {
                const dateInput = document.getElementById('bus-date');
                if (dateInput) {
                    dateInput.min = getTodayDate();
                }
            }, 3600000);
            
            console.log('‚öôÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∏—à—Ç–µ—Ç–∏–ª–¥–∏');
            showNotification('–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∂“Ø–∫—Ç”©–ª–¥“Ø!');
        }

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –®–ê–ë–õ–û–ù–û–í –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
        function initDefaultTemplates() {
            if (Object.keys(database.templates).length === 0) {
                database.templates = {
                    morning: {
                        name: '–≠—Ä—Ç–µ“£ –º–µ–Ω–µ–Ω',
                        description: '–≠—Ä—Ç–µ“£ –º–µ–Ω–µ–Ω –ø–æ–ø—É–ª—è—Ä–¥—É—É –±–∞–≥—ã—Ç—Ç–∞—Ä',
                        routes: [
                            {route: '–ë–∏—à–∫–µ–∫', time: '06:30', vehicle: 'bus', seats: 45, available: 45, driver: '–≠–º–∏–ª–±–µ–∫ —É—É–ª—É', carrier: '–ö–∞—Ä–∞–∫–æ–ª –¢—Ä–∞–Ω—Å', price: 350},
                            {route: '–û—à', time: '07:00', vehicle: 'bus', seats: 40, available: 40, driver: '–ù—É—Ä–ª–∞–Ω —É—É–ª—É', carrier: '–¢“Ø—à—Ç“Ø–∫ –ñ–æ–ª', price: 800},
                            {route: '–ù–∞—Ä—ã–Ω', time: '08:30', vehicle: 'minibus', seats: 20, available: 20, driver: '–ë–∞–∫—ã—Ç —É—É–ª—É', carrier: '–ö”©–ª –¢—É—Ä', price: 200}
                        ]
                    },
                    evening: {
                        name: '–ö–µ—á–∏–Ω–¥–µ',
                        description: '–ö–µ—á–∫–∏ —É–±–∞–∫—ã—Ç—Ç–∞–≥—ã –±–∞–≥—ã—Ç—Ç–∞—Ä',
                        routes: [
                            {route: '–ë–∏—à–∫–µ–∫', time: '15:30', vehicle: 'bus', seats: 48, available: 48, driver: '–ú–µ–¥–µ—Ç —É—É–ª—É', carrier: '–ê–ª–∞-–¢–æ–æ –≠–∫—Å–ø—Ä–µ—Å—Å', price: 350},
                            {route: '–ê–ª–º–∞—Ç—ã', time: '16:00', vehicle: 'bus', seats: 52, available: 52, driver: '–ê–∑–∞–º–∞—Ç —É—É–ª—É', carrier: '–ê–∫-–ñ–æ–ª –ê–≤—Ç–æ', price: 1200},
                            {route: '–ë–∞–ª—ã–∫—á—ã', time: '17:30', vehicle: 'minibus', seats: 18, available: 18, driver: '–¢–∞–ª–∞–Ω—Ç —É—É–ª—É', carrier: '–ö”©–ª –¢—É—Ä', price: 120}
                        ]
                    }
                };
                saveData();
            }
        }

        // –ü–†–û–í–ï–†–ö–ê –°–ï–°–°–ò–ò
        window.addEventListener('load', function() {
            if (!checkAdminAccess()) {
                return;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-screen').classList.add('active');
            init();
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        setInterval(() => {
            checkAdminAccess();
        }, 300000);

        // –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï
        setInterval(() => {
            if (buses.length > 0 || dayStarted) {
                saveData();
            }
        }, 30000);

        // –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveData();
                showNotification('–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä —Å–∞–∫—Ç–∞–ª–¥—ã!');
            }
        });
    </script>
</body>
</html>