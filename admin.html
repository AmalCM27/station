<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ö–∞—Ä–∞–∫–æ–ª –ê–≤—Ç–æ–±–µ–∫–µ—Ç–∏</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #fff;
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: #1e3a8a;
            padding: 20px 40px;
            text-align: center;
            border-bottom: 3px solid #3b82f6;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 16px;
            color: #64748b;
        }

        /* NAVIGATION */
        .nav {
            background: #1e293b;
            padding: 0;
            display: flex;
            border-bottom: 1px solid #334155;
        }

        .nav-item {
            flex: 1;
            padding: 18px 20px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-right: 1px solid #334155;
        }

        .nav-item:last-child {
            border-right: none;
        }

        .nav-item.active {
            background: #3b82f6;
            color: #fff;
        }

        .nav-item:hover:not(.active) {
            background: #374151;
            color: #fff;
        }

        /* CONTENT */
        .content {
            padding: 30px 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .section {
            display: none;
            margin-bottom: 40px;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1e293b;
        }

        /* FORMS */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #cbd5e1;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            background: #1e293b;
            border: 1px solid #334155;
            color: #fff;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            background: #262d3d;
        }

        .form-group input::placeholder {
            color: #64748b;
        }

        /* BUTTONS */
        .btn {
            background: #3b82f6;
            border: none;
            color: #fff;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* ROUTES LIST */
        .routes-list {
            background: #1e293b;
            border-radius: 8px;
            border: 1px solid #334155;
            overflow: hidden;
        }

        .route-item {
            display: grid;
            grid-template-columns: 200px 100px 120px 100px 150px 120px 100px 1fr;
            gap: 20px;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #334155;
            transition: all 0.3s ease;
        }

        .route-item:last-child {
            border-bottom: none;
        }

        .route-item:hover {
            background: #262d3d;
        }

        .route-item.header {
            background: #334155;
            font-weight: 600;
            color: #3b82f6;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .route-item.header:hover {
            background: #334155;
        }

        .route-field {
            font-size: 14px;
            color: #e2e8f0;
        }

        .route-time {
            font-family: 'Inter', monospace;
            font-weight: 500;
            color: #fbbf24;
        }

        .route-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            text-transform: uppercase;
        }

        .status-waiting {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-boarding {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-delayed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-departed {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }

        .route-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }

        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 300;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* TEMPLATES */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .template-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            border-color: #3b82f6;
            background: #262d3d;
        }

        .template-title {
            font-size: 18px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .template-desc {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .template-routes {
            max-height: 150px;
            overflow-y: auto;
        }

        .template-route {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #334155;
            font-size: 12px;
            color: #cbd5e1;
        }

        .template-route:last-child {
            border-bottom: none;
        }

        /* NOTIFICATIONS */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #10b981;
            color: #fff;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.warning {
            background: #f59e0b;
        }

        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #334155;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .nav {
                flex-direction: column;
            }

            .route-item {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: left;
            }

            .route-item.header {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöå –ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò - –ê–î–ú–ò–ù</h1>
        <p>–ë–∞—à–∫–∞—Ä—É—É –ø–∞–Ω–µ–ª–∏ ‚Ä¢ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
    </div>

    <div class="nav">
        <button class="nav-item active" onclick="showSection('manage')">–ë–∞—à–∫–∞—Ä—É—É</button>
        <button class="nav-item" onclick="showSection('templates')">–®–∞–±–ª–æ–Ω–¥–æ—Ä</button>
        <button class="nav-item" onclick="showSection('history')">–¢–∞—Ä—ã—Ö</button>
        <button class="nav-item" onclick="showSection('reports')">–û—Ç—á–µ—Ç—Ç–æ—Ä</button>
        <button class="nav-item" onclick="showSection('settings')">–ñ”©–Ω–¥”©”©–ª”©—Ä</button>
    </div>

    <div class="content">
        <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï -->
        <div class="section active" id="manage-section">
            <div class="section-title">–ñ–∞“£—ã –∞–≤—Ç–æ–±—É—Å –∫–æ—à—É—É</div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>–ë–∞–≥—ã—Ç ‚Ä¢ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                    <input type="text" id="route" placeholder="–ë–∏—à–∫–µ–∫">
                </div>
                <div class="form-group">
                    <label>–ö“Ø–Ω“Ø ‚Ä¢ –î–∞—Ç–∞</label>
                    <input type="date" id="bus-date">
                </div>
                <div class="form-group">
                    <label>–£–±–∞–∫—ã—Ç ‚Ä¢ –í—Ä–µ–º—è</label>
                    <input type="time" id="time">
                </div>
                <div class="form-group">
                    <label>–û—Ä—É–Ω–¥–∞—Ä ‚Ä¢ –ú–µ—Å—Ç–∞</label>
                    <input type="number" id="seats" placeholder="45" min="20" max="80">
                </div>
                <div class="form-group">
                    <label>–ê–π–¥–æ–æ—á—É ‚Ä¢ –í–æ–¥–∏—Ç–µ–ª—å</label>
                    <input type="text" id="driver" placeholder="–≠–º–∏–ª–±–µ–∫ —É—É–ª—É">
                </div>
                <div class="form-group">
                    <label>–¢–∞—à—É—É—á—É ‚Ä¢ –ü–µ—Ä–µ–≤–æ–∑—á–∏–∫</label>
                    <input type="text" id="carrier" placeholder="–ö–∞—Ä–∞–∫–æ–ª –¢—Ä–∞–Ω—Å">
                </div>
                <div class="form-group">
                    <label>–ë–∞–∞—Å—ã ‚Ä¢ –¶–µ–Ω–∞ (—Å–æ–º)</label>
                    <input type="number" id="price" placeholder="350" min="50">
                </div>
                <div class="form-group">
                    <label>–ê–±–∞–ª—ã ‚Ä¢ –°—Ç–∞—Ç—É—Å</label>
                    <select id="status">
                        <option value="waiting">–ö“Ø—Ç“Ø“Ø–¥”©</option>
                        <option value="boarding">–û—Ç—É—Ä–≥—É–∑—É—É</option>
                        <option value="delayed">–ö–µ—á–∏–≥“Ø“Ø</option>
                        <option value="departed">–ö–µ—Ç—Ç–∏</option>
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <button class="btn" onclick="addBus()">‚ûï –ö–æ—à—É—É</button>
                <button class="btn btn-secondary" onclick="addRandomBus()">üé≤ –ö–æ–∫—É—Å—Ç—É–∫</button>
                <button class="btn btn-success" onclick="clearForm()">üîÑ –¢–∞–∑–∞–ª–æ–æ</button>
                <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è –ë–∞–∞—Ä—ã–Ω ”©—á“Ø—Ä“Ø“Ø</button>
            </div>

            <div class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">–ë–∞—Ä–¥—ã–≥—ã</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="waiting-count">0</div>
                    <div class="stat-label">–ö“Ø—Ç“Ø“Ø–¥”©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="boarding-count">0</div>
                    <div class="stat-label">–û—Ç—É—Ä–≥—É–∑—É—É</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="departed-count">0</div>
                    <div class="stat-label">–ö–µ—Ç—Ç–∏</div>
                </div>
            </div>

            <div class="section-title">–£—á—É—Ä–¥–∞–≥—ã –∞–≤—Ç–æ–±—É—Å—Ç–∞—Ä</div>
            <div class="routes-list">
                <div class="route-item header">
                    <div>–ë–∞–≥—ã—Ç</div>
                    <div>–£–±–∞–∫—ã—Ç</div>
                    <div>–ê–±–∞–ª—ã</div>
                    <div>–û—Ä—É–Ω–¥–∞—Ä</div>
                    <div>–ê–π–¥–æ–æ—á—É</div>
                    <div>–¢–∞—à—É—É—á—É</div>
                    <div>–ë–∞–∞—Å—ã</div>
                    <div>–ê—Ä–∞–∫–µ—Ç—Ç–µ—Ä</div>
                </div>
                <div id="routes-container">
                    <!-- –†–µ–π—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <!-- –®–ê–ë–õ–û–ù–´ –ò –ú–ê–°–°–û–í–´–ï –û–ü–ï–†–ê–¶–ò–ò -->
        <div class="section" id="templates-section">
            <div class="section-title">–®–∞–±–ª–æ–Ω–¥–æ—Ä –∂–∞–Ω–∞ –º–∞—Å—Å–∞–ª—ã–∫ –∞—Ä–∞–∫–µ—Ç—Ç–µ—Ä</div>
            
            <div style="margin-bottom: 30px;">
                <button class="btn" onclick="showCreateTemplateModal()">‚ûï –ñ–∞“£—ã —à–∞–±–ª–æ–Ω</button>
                <button class="btn btn-secondary" onclick="importFromFile()">üìÅ –ò–º–ø–æ—Ä—Ç</button>
                <button class="btn btn-success" onclick="exportToFile()">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>

            <div class="templates-grid" id="templates-container">
                <!-- –®–∞–±–ª–æ–Ω—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>

            <div class="section-title">–ú–∞—Å—Å–∞–ª—ã–∫ –∞—Ä–∞–∫–µ—Ç—Ç–µ—Ä</div>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="updateAllStatuses('boarding')">üü¢ –ë–∞–∞—Ä—ã–Ω –æ—Ç—É—Ä–≥—É–∑—É—É–≥–∞</button>
                <button class="btn btn-secondary" onclick="updateAllStatuses('delayed')">üü° –ë–∞–∞—Ä—ã–Ω –∫–µ—á–∏–∫—Ç–∏—Ä“Ø“Ø</button>
                <button class="btn btn-danger" onclick="updateAllStatuses('departed')">üî¥ –ë–∞–∞—Ä—ã–Ω –∂”©–Ω”©—Ç“Ø“Ø</button>
            </div>
        </div>

        <!-- –ò–°–¢–û–†–ò–Ø -->
        <div class="section" id="history-section">
            <div class="section-title">–°–∏—Å—Ç–µ–º–∞–Ω—ã–Ω —Ç–∞—Ä—ã—Ö—ã</div>
            
            <div class="form-grid" style="max-width: 600px;">
                <div class="form-group">
                    <label>–ö“Ø–Ω“Ø —Ç–∞–Ω–¥–æ–æ</label>
                    <input type="date" id="history-date">
                </div>
                <div class="form-group">
                    <label>–ê—Ä–∞–∫–µ—Ç —Ç“Ø—Ä“Ø</label>
                    <select id="history-filter">
                        <option value="">–ë–∞–∞—Ä–¥—ã–∫ –∞—Ä–∞–∫–µ—Ç—Ç–µ—Ä</option>
                        <option value="add">–ö–æ—à—É—É</option>
                        <option value="edit">”®–∑–≥”©—Ä—Ç“Ø“Ø</option>
                        <option value="delete">”®—á“Ø—Ä“Ø“Ø</option>
                        <option value="status">–°—Ç–∞—Ç—É—Å ”©–∑–≥”©—Ä—Ç“Ø“Ø</option>
                    </select>
                </div>
            </div>
            
            <button class="btn" onclick="loadHistory()">üìä –¢–∞—Ä—ã—Ö—Ç—ã –∂“Ø–∫—Ç”©”©</button>
            
            <div id="history-container" style="margin-top: 30px;">
                <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>

        <!-- –û–¢–ß–ï–¢–´ -->
        <div class="section" id="reports-section">
            <div class="section-title">–û—Ç—á–µ—Ç—Ç–æ—Ä –∂–∞–Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
            
            <div class="form-grid" style="max-width: 600px;">
                <div class="form-group">
                    <label>–û—Ç—á–µ—Ç –∫“Ø–Ω“Ø</label>
                    <input type="date" id="report-date">
                </div>
                <div class="form-group">
                    <label>–û—Ç—á–µ—Ç —Ç“Ø—Ä“Ø</label>
                    <select id="report-type">
                        <option value="daily">–ö“Ø–Ω–¥“Ø–∫</option>
                        <option value="weekly">–ñ—É–º–∞–ª—ã–∫</option>
                        <option value="monthly">–ê–π–ª—ã–∫</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <button class="btn" onclick="generateReport()">üìä –û—Ç—á–µ—Ç —Ç“Ø–∑“Ø“Ø</button>
                <button class="btn btn-secondary" onclick="exportToPDF()">üìÑ PDF</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Excel</button>
            </div>
            
            <div id="report-container">
                <!-- –û—Ç—á–µ—Ç—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>

        <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div class="section" id="settings-section">
            <div class="section-title">–°–∏—Å—Ç–µ–º–∞ –∂”©–Ω–¥”©”©–ª”©—Ä“Ø</div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>–ñ–∞“£—ã—Ä—Ç—É—É –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (—Å–µ–∫)</label>
                    <input type="number" id="update-interval" value="3" min="1" max="60">
                </div>
                <div class="form-group">
                    <label>–î–æ–±—É—à –∫“Ø—á“Ø</label>
                    <input type="range" id="volume" min="0" max="1" step="0.1" value="0.8">
                    <span id="volume-display">80%</span>
                </div>
                <div class="form-group">
                    <label>–ê–≤—Ç–æ ”©—á“Ø—Ä“Ø“Ø (–º“Ø–Ω”©—Ç)</label>
                    <input type="number" id="auto-remove" value="1" min="1" max="60">
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <button class="btn" onclick="saveSettings()">üíæ –°–∞–∫—Ç–æ–æ</button>
                <button class="btn btn-secondary" onclick="testAnnouncement()">üîä –î–æ–±—É—à —Ç–µ—Å—Ç–∏</button>
                <button class="btn btn-danger" onclick="resetSystem()">üîÑ –°–∏—Å—Ç–µ–º–∞–Ω—ã –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä“Ø“Ø</button>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-title">–ú–æ–¥–∞–ª</div>
            <div id="modal-body">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª–∞ -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">–ñ–∞–±—É—É</button>
                <button class="btn" id="modal-confirm" onclick="confirmModal()">–´—Ä–∞–∞–∑—ã</button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div class="notification" id="notification"></div>

    <script>
        let buses = [];
        let busCounter = 1;
        let database = {
            buses: [],
            deleted: [],
            history: [],
            templates: {
                morning: {
                    name: '–≠—Ä—Ç–µ“£ –º–µ–Ω–µ–Ω',
                    description: '–≠—Ä—Ç–µ“£ –º–µ–Ω–µ–Ω –ø–æ–ø—É–ª—è—Ä–¥—É—É –±–∞–≥—ã—Ç—Ç–∞—Ä',
                    routes: [
                        {route: '–ë–∏—à–∫–µ–∫', time: '06:30', seats: 45, driver: '–≠–º–∏–ª–±–µ–∫ —É—É–ª—É', carrier: '–ö–∞—Ä–∞–∫–æ–ª –¢—Ä–∞–Ω—Å', price: 350},
                        {route: '–û—à', time: '07:00', seats: 40, driver: '–ù—É—Ä–ª–∞–Ω —É—É–ª—É', carrier: '–¢“Ø—à—Ç“Ø–∫ –ñ–æ–ª', price: 800},
                        {route: '–ù–∞—Ä—ã–Ω', time: '08:30', seats: 35, driver: '–ë–∞–∫—ã—Ç —É—É–ª—É', carrier: '–ö”©–ª –¢—É—Ä', price: 200}
                    ]
                },
                evening: {
                    name: '–ö–µ—á–∏–Ω–¥–µ',
                    description: '–ö–µ—á–∫–∏ —É–±–∞–∫—ã—Ç—Ç–∞–≥—ã –±–∞–≥—ã—Ç—Ç–∞—Ä',
                    routes: [
                        {route: '–ë–∏—à–∫–µ–∫', time: '15:30', seats: 48, driver: '–ú–µ–¥–µ—Ç —É—É–ª—É', carrier: '–ê–ª–∞-–¢–æ–æ –≠–∫—Å–ø—Ä–µ—Å—Å', price: 350},
                        {route: '–ê–ª–º–∞—Ç—ã', time: '16:00', seats: 52, driver: '–ê–∑–∞–º–∞—Ç —É—É–ª—É', carrier: '–ê–∫-–ñ–æ–ª –ê–≤—Ç–æ', price: 1200},
                        {route: '–ë–∞–ª—ã–∫—á—ã', time: '17:30', seats: 38, driver: '–¢–∞–ª–∞–Ω—Ç —É—É–ª—É', carrier: '–ö”©–ª –¢—É—Ä', price: 120}
                    ]
                }
            }
        };

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showSection(sectionName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(sectionName + '-section').classList.add('active');
            
            if (sectionName === 'history') {
                document.getElementById('history-date').value = getTodayDate();
            }
            if (sectionName === 'reports') {
                document.getElementById('report-date').value = getTodayDate();
            }
            if (sectionName === 'templates') {
                renderTemplates();
            }
        }

        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        function setDefaultTime() {
            const now = new Date();
            const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
            document.getElementById('time').value = oneHourLater.toTimeString().slice(0, 5);
        }

        function validateDateTime() {
            const selectedTime = document.getElementById('time').value;
            const selectedDate = document.getElementById('bus-date').value;
            
            if (!selectedTime || !selectedDate) {
                showNotification('–£–±–∞–∫—ã—Ç –∂–∞–Ω–∞ –∫“Ø–Ω“Ø–Ω —Ç–∞–Ω–¥–∞“£—ã–∑!', 'error');
                return false;
            }
            
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            
            if (selectedDate < currentDate) {
                showNotification('”®—Ç–∫”©–Ω –∫“Ø–Ω–≥”© –∞–≤—Ç–æ–±—É—Å –∫–æ—à—É—É–≥–∞ –±–æ–ª–±–æ–π—Ç!', 'error');
                return false;
            }
            
            if (selectedDate === currentDate) {
                const [hours, minutes] = selectedTime.split(':').map(Number);
                const selectedTimeInMinutes = hours * 60 + minutes;
                const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
                
                if (selectedTimeInMinutes <= currentTimeInMinutes) {
                    showNotification('”®—Ç–∫”©–Ω —É–±–∞–∫—ã—Ç–∫–∞ –∞–≤—Ç–æ–±—É—Å –∫–æ—à—É—É–≥–∞ –±–æ–ª–±–æ–π—Ç!', 'error');
                    return false;
                }
            }
            
            return true;
        }

        function addBus() {
            const route = document.getElementById('route').value.trim();
            const time = document.getElementById('time').value;
            const seats = parseInt(document.getElementById('seats').value);
            const driver = document.getElementById('driver').value.trim();
            const carrier = document.getElementById('carrier').value.trim();
            const price = parseInt(document.getElementById('price').value);
            const status = document.getElementById('status').value;
            const busDate = document.getElementById('bus-date').value;

            if (!route || !time || !seats || !driver || !carrier || !price) {
                showNotification('–ë–∞—Ä–¥—ã–∫ —Ç–∞–ª–∞–∞–ª–∞—Ä–¥—ã —Ç–æ–ª—Ç—É—Ä—É“£—É–∑!', 'error');
                return;
            }

            if (!validateDateTime()) {
                return;
            }

            if (seats < 20 || seats > 80) {
                showNotification('–û—Ä—É–Ω–¥–∞—Ä —Å–∞–Ω—ã 20–¥–æ–Ω 80–≥”© —á–µ–π–∏–Ω –±–æ–ª—É—à—É –∫–µ—Ä–µ–∫!', 'error');
                return;
            }

            if (price < 50) {
                showNotification('–ë–∞–∞—Å—ã –∫–µ–º–∏–Ω–¥–µ 50 —Å–æ–º –±–æ–ª—É—à—É –∫–µ—Ä–µ–∫!', 'error');
                return;
            }

            const newBus = {
                id: busCounter++,
                route, time, seats, driver, carrier, price, status,
                date: busDate,
                created: new Date(),
                announcements: {
                    fiveMinutes: false,
                    boarding: false,
                    departed: false
                }
            };

            buses.push(newBus);
            addToHistory('add', newBus);
            saveData();
            clearForm();
            updateDisplay();
            setDefaultTime();
            showNotification(`${route} –±–∞–≥—ã—Ç—ã–Ω–∞ –∞–≤—Ç–æ–±—É—Å –∫–æ—à—É–ª–¥—É!`);
        }

        function addRandomBus() {
            const routes = ['–ë–∏—à–∫–µ–∫', '–ê–ª–º–∞—Ç—ã', '–û—à', '–ù–∞—Ä—ã–Ω', '–ß–æ–ª–ø–æ–Ω-–ê—Ç–∞', '–ë–∞–ª—ã–∫—á—ã', '–¢–æ–∫–º–æ–∫'];
            const carriers = ['–ö–∞—Ä–∞–∫–æ–ª –¢—Ä–∞–Ω—Å', '–ê–ª–∞-–¢–æ–æ –≠–∫—Å–ø—Ä–µ—Å—Å', '–¢“Ø—à—Ç“Ø–∫ –ñ–æ–ª', '–ö”©–ª –¢—É—Ä'];
            const drivers = ['–≠–º–∏–ª–±–µ–∫ —É—É–ª—É', '–ù—É—Ä–ª–∞–Ω —É—É–ª—É', '–ë–∞–∫—ã—Ç —É—É–ª—É', '–ú–µ–¥–µ—Ç —É—É–ª—É'];
            const prices = [120, 150, 200, 280, 350, 800, 1200];

            const now = new Date();
            const future = new Date(now.getTime() + Math.random() * 6 * 60 * 60 * 1000);

            const newBus = {
                id: busCounter++,
                route: routes[Math.floor(Math.random() * routes.length)],
                time: future.toTimeString().slice(0, 5),
                seats: Math.floor(Math.random() * 40) + 30,
               driver: drivers[Math.floor(Math.random() * drivers.length)],
               carrier: carriers[Math.floor(Math.random() * carriers.length)],
               price: prices[Math.floor(Math.random() * prices.length)],
               status: 'waiting',
               date: getTodayDate(),
               created: new Date(),
               announcements: {
                   fiveMinutes: false,
                   boarding: false,
                   departed: false
               }
           };

           buses.push(newBus);
           addToHistory('add', newBus, { type: 'random' });
           saveData();
           updateDisplay();
           showNotification(`–ö–æ–∫—É—Å—Ç—É–∫ –∞–≤—Ç–æ–±—É—Å ${newBus.route} –∫–æ—à—É–ª–¥—É!`);
       }

       function editBus(busId) {
           const bus = buses.find(b => b.id === busId);
           if (!bus) return;

           const modalBody = document.getElementById('modal-body');
           modalBody.innerHTML = `
               <div class="form-grid">
                   <div class="form-group">
                       <label>–ë–∞–≥—ã—Ç</label>
                       <input type="text" id="edit-route" value="${bus.route}">
                   </div>
                   <div class="form-group">
                       <label>–£–±–∞–∫—ã—Ç</label>
                       <input type="time" id="edit-time" value="${bus.time}">
                   </div>
                   <div class="form-group">
                       <label>–û—Ä—É–Ω–¥–∞—Ä</label>
                       <input type="number" id="edit-seats" value="${bus.seats}" min="20" max="80">
                   </div>
                   <div class="form-group">
                       <label>–ê–π–¥–æ–æ—á—É</label>
                       <input type="text" id="edit-driver" value="${bus.driver}">
                   </div>
                   <div class="form-group">
                       <label>–¢–∞—à—É—É—á—É</label>
                       <input type="text" id="edit-carrier" value="${bus.carrier}">
                   </div>
                   <div class="form-group">
                       <label>–ë–∞–∞—Å—ã</label>
                       <input type="number" id="edit-price" value="${bus.price}" min="50">
                   </div>
                   <div class="form-group">
                       <label>–ê–±–∞–ª—ã</label>
                       <select id="edit-status">
                           <option value="waiting" ${bus.status === 'waiting' ? 'selected' : ''}>–ö“Ø—Ç“Ø“Ø–¥”©</option>
                           <option value="boarding" ${bus.status === 'boarding' ? 'selected' : ''}>–û—Ç—É—Ä–≥—É–∑—É—É</option>
                           <option value="delayed" ${bus.status === 'delayed' ? 'selected' : ''}>–ö–µ—á–∏–≥“Ø“Ø</option>
                           <option value="departed" ${bus.status === 'departed' ? 'selected' : ''}>–ö–µ—Ç—Ç–∏</option>
                       </select>
                   </div>
               </div>
           `;

           document.getElementById('modal-title').textContent = '–ê–≤—Ç–æ–±—É—Å—Ç—É ”©–∑–≥”©—Ä—Ç“Ø“Ø';
           document.getElementById('modal-confirm').onclick = () => confirmEditBus(busId);
           showModal();
       }

       function confirmEditBus(busId) {
           const bus = buses.find(b => b.id === busId);
           if (!bus) return;

           const oldData = { ...bus };
           
           bus.route = document.getElementById('edit-route').value.trim();
           bus.time = document.getElementById('edit-time').value;
           bus.seats = parseInt(document.getElementById('edit-seats').value);
           bus.driver = document.getElementById('edit-driver').value.trim();
           bus.carrier = document.getElementById('edit-carrier').value.trim();
           bus.price = parseInt(document.getElementById('edit-price').value);
           bus.status = document.getElementById('edit-status').value;

           if (!bus.route || !bus.time || !bus.seats || !bus.driver || !bus.carrier || !bus.price) {
               showNotification('–ë–∞—Ä–¥—ã–∫ —Ç–∞–ª–∞–∞–ª–∞—Ä–¥—ã —Ç–æ–ª—Ç—É—Ä—É“£—É–∑!', 'error');
               return;
           }

           addToHistory('edit', bus, { oldData, newData: { ...bus } });
           saveData();
           updateDisplay();
           closeModal();
           showNotification('–ê–≤—Ç–æ–±—É—Å –º–∞–∞–ª—ã–º–∞—Ç—ã ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø!');
       }

       function deleteBus(busId) {
           const bus = buses.find(b => b.id === busId);
           if (!bus) return;

           if (confirm(`${bus.route} –±–∞–≥—ã—Ç—ã–Ω–¥–∞–≥—ã –∞–≤—Ç–æ–±—É—Å—Ç—É ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?`)) {
               const busIndex = buses.findIndex(b => b.id === busId);
               database.deleted.push({
                   ...bus,
                   deletedAt: new Date(),
                   deletedBy: 'admin'
               });
               buses.splice(busIndex, 1);
               addToHistory('delete', bus);
               saveData();
               updateDisplay();
               showNotification(`${bus.route} –∞–≤—Ç–æ–±—É—Å—É ”©—á“Ø—Ä“Ø–ª–¥“Ø`);
           }
       }

       function changeStatus(busId) {
           const bus = buses.find(b => b.id === busId);
           if (!bus) return;

           const statuses = ['waiting', 'boarding', 'delayed', 'departed'];
           const currentIndex = statuses.indexOf(bus.status);
           const nextIndex = (currentIndex + 1) % statuses.length;
           
           const oldStatus = bus.status;
           bus.status = statuses[nextIndex];
           
           addToHistory('status', bus, { oldStatus, newStatus: bus.status });
           saveData();
           updateDisplay();
           showNotification(`${bus.route} —Å—Ç–∞—Ç—É—Å—É ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø`);
       }

       function clearAll() {
           if (confirm('–ë–∞—Ä–¥—ã–∫ –∞–≤—Ç–æ–±—É—Å—Ç–∞—Ä–¥—ã ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?')) {
               buses.forEach(bus => {
                   database.deleted.push({
                       ...bus,
                       deletedAt: new Date(),
                       deletedBy: 'admin_clear_all'
                   });
                   addToHistory('delete', bus, { type: 'clear_all' });
               });
               buses = [];
               saveData();
               updateDisplay();
               showNotification('–ë–∞—Ä–¥—ã–∫ –∞–≤—Ç–æ–±—É—Å—Ç–∞—Ä ”©—á“Ø—Ä“Ø–ª–¥“Ø');
           }
       }

       function clearForm() {
           document.getElementById('route').value = '';
           document.getElementById('time').value = '';
           document.getElementById('seats').value = '';
           document.getElementById('driver').value = '';
           document.getElementById('carrier').value = '';
           document.getElementById('price').value = '';
           document.getElementById('status').value = 'waiting';
           document.getElementById('bus-date').value = getTodayDate();
           setDefaultTime();
       }

       function updateDisplay() {
           updateStats();
           renderRoutes();
       }

       function updateStats() {
           document.getElementById('total-count').textContent = buses.length;
           document.getElementById('waiting-count').textContent = buses.filter(b => b.status === 'waiting').length;
           document.getElementById('boarding-count').textContent = buses.filter(b => b.status === 'boarding').length;
           document.getElementById('departed-count').textContent = buses.filter(b => b.status === 'departed').length;
       }

       function renderRoutes() {
           const container = document.getElementById('routes-container');
           
           if (buses.length === 0) {
               container.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">–ê–≤—Ç–æ–±—É—Å—Ç–∞—Ä –∂–æ–∫</div>';
               return;
           }

           container.innerHTML = buses.map(bus => `
               <div class="route-item">
                   <div class="route-field">${bus.route}</div>
                   <div class="route-field route-time">${bus.time}</div>
                   <div class="route-status status-${bus.status}">${getStatusText(bus.status)}</div>
                   <div class="route-field">${bus.seats}</div>
                   <div class="route-field">${bus.driver}</div>
                   <div class="route-field">${bus.carrier}</div>
                   <div class="route-field">${bus.price} —Å–æ–º</div>
                   <div class="route-actions">
                       <button class="btn btn-small" onclick="editBus(${bus.id})">‚úèÔ∏è</button>
                       <button class="btn btn-small btn-secondary" onclick="changeStatus(${bus.id})">üîÑ</button>
                       <button class="btn btn-small btn-danger" onclick="deleteBus(${bus.id})">üóëÔ∏è</button>
                   </div>
               </div>
           `).join('');
       }

       function getStatusText(status) {
           const texts = {
               'waiting': '–ö“Ø—Ç“Ø“Ø–¥”©',
               'boarding': '–û—Ç—É—Ä–≥—É–∑—É—É',
               'delayed': '–ö–µ—á–∏–≥“Ø“Ø',
               'departed': '–ö–µ—Ç—Ç–∏'
           };
           return texts[status] || status;
       }

       function addToHistory(action, busData, details = {}) {
           const historyEntry = {
               id: Date.now(),
               timestamp: new Date(),
               action: action,
               bus: { ...busData },
               details: details
           };
           database.history.push(historyEntry);
       }

       function loadHistory() {
           const selectedDate = document.getElementById('history-date').value;
           const filter = document.getElementById('history-filter').value;
           
           if (!selectedDate) {
               showNotification('–ö“Ø–Ω —Ç–∞–Ω–¥–∞“£—ã–∑!', 'error');
               return;
           }
           
           const date = new Date(selectedDate);
           const dateStr = date.toDateString();
           
           let history = database.history.filter(h => 
               new Date(h.timestamp).toDateString() === dateStr
           );
           
           if (filter) {
               history = history.filter(h => h.action === filter);
           }
           
           const container = document.getElementById('history-container');
           
           if (history.length === 0) {
               container.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">–ë—É–ª –∫“Ø–Ω–¥”© —ç—á –∫–∞–Ω–¥–∞–π –∞—Ä–∞–∫–µ—Ç –∂–æ–∫</div>';
               return;
           }
           
           container.innerHTML = `
               <div class="routes-list">
                   <div class="route-item header">
                       <div>–£–±–∞–∫—ã—Ç</div>
                       <div>–ê—Ä–∞–∫–µ—Ç</div>
                       <div>–ë–∞–≥—ã—Ç</div>
                       <div>–î–µ—Ç–∞–ª–∏</div>
                       <div></div>
                       <div></div>
                       <div></div>
                       <div></div>
                   </div>
                   ${history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(h => `
                       <div class="route-item">
                           <div class="route-field route-time">${new Date(h.timestamp).toLocaleTimeString('ru-RU')}</div>
                           <div class="route-field">${getActionText(h.action)}</div>
                           <div class="route-field">${h.bus.route}</div>
                           <div class="route-field">${getDetailsText(h.action, h.details)}</div>
                           <div></div>
                           <div></div>
                           <div></div>
                           <div></div>
                       </div>
                   `).join('')}
               </div>
           `;
       }

       function getActionText(action) {
           const actions = {
               'add': '–ö–æ—à—É–ª–¥—É',
               'edit': '”®–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø',
               'delete': '”®—á“Ø—Ä“Ø–ª–¥“Ø',
               'status': '–°—Ç–∞—Ç—É—Å ”©–∑–≥”©—Ä–¥“Ø'
           };
           return actions[action] || action;
       }

       function getDetailsText(action, details) {
           if (!details) return '-';
           if (action === 'status') {
               return `${getStatusText(details.oldStatus)} ‚Üí ${getStatusText(details.newStatus)}`;
           }
           if (details.type) {
               return details.type === 'random' ? '–ö–æ–∫—É—Å—Ç—É–∫' : details.type;
           }
           return '-';
       }

       function renderTemplates() {
           const container = document.getElementById('templates-container');
           
           container.innerHTML = Object.entries(database.templates).map(([key, template]) => `
               <div class="template-card" onclick="applyTemplate('${key}')">
                   <div class="template-title">${template.name}</div>
                   <div class="template-desc">${template.description}</div>
                   <div class="template-routes">
                       ${template.routes.map(route => `
                           <div class="template-route">
                               <span>${route.route}</span>
                               <span>${route.time}</span>
                               <span>${route.price} —Å–æ–º</span>
                           </div>
                       `).join('')}
                   </div>
                   <div style="margin-top: 15px;">
                       <button class="btn btn-small" onclick="event.stopPropagation(); editTemplate('${key}')">‚úèÔ∏è</button>
                       <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteTemplate('${key}')">üóëÔ∏è</button>
                   </div>
               </div>
           `).join('');
       }

       function applyTemplate(templateKey) {
           const template = database.templates[templateKey];
           if (!template) return;

           let added = 0;
           template.routes.forEach((routeData, index) => {
               setTimeout(() => {
                   const newBus = {
                       id: busCounter++,
                       ...routeData,
                       status: 'waiting',
                       date: getTodayDate(),
                       created: new Date(),
                       announcements: {
                           fiveMinutes: false,
                           boarding: false,
                           departed: false
                       }
                   };

                   buses.push(newBus);
                   addToHistory('add', newBus, { template: templateKey });
                   added++;

                   if (added === template.routes.length) {
                       saveData();
                       updateDisplay();
                       showNotification(`${template.name} —à–∞–±–ª–æ–Ω—É –∫–æ–ª–¥–æ–Ω—É–ª–¥—É! ${added} –∞–≤—Ç–æ–±—É—Å –∫–æ—à—É–ª–¥—É`);
                   }
               }, index * 100);
           });
       }

       function showCreateTemplateModal() {
           const modalBody = document.getElementById('modal-body');
           modalBody.innerHTML = `
               <div class="form-grid">
                   <div class="form-group">
                       <label>–®–∞–±–ª–æ–Ω –∞—Ç—ã</label>
                       <input type="text" id="template-name" placeholder="–ñ–∞“£—ã —à–∞–±–ª–æ–Ω">
                   </div>
                   <div class="form-group">
                       <label>–°“Ø—Ä”©—Ç—Ç”©–º”©</label>
                       <textarea id="template-desc" placeholder="–®–∞–±–ª–æ–Ω –∂”©–Ω“Ø–Ω–¥”© –º–∞–∞–ª—ã–º–∞—Ç" rows="3"></textarea>
                   </div>
               </div>
               <p style="color: #64748b; margin-top: 15px;">–£—á—É—Ä–¥–∞–≥—ã –∞–≤—Ç–æ–±—É—Å—Ç–∞—Ä —à–∞–±–ª–æ–Ω –∫–∞—Ç–∞—Ä—ã —Å–∞–∫—Ç–∞–ª–∞—Ç</p>
           `;

           document.getElementById('modal-title').textContent = '–ñ–∞“£—ã —à–∞–±–ª–æ–Ω —Ç“Ø–∑“Ø“Ø';
           document.getElementById('modal-confirm').onclick = createTemplate;
           showModal();
       }

       function createTemplate() {
           const name = document.getElementById('template-name').value.trim();
           const desc = document.getElementById('template-desc').value.trim();

           if (!name) {
               showNotification('–®–∞–±–ª–æ–Ω –∞—Ç—ã–Ω –∂–∞–∑—ã“£—ã–∑!', 'error');
               return;
           }

           if (buses.length === 0) {
               showNotification('–®–∞–±–ª–æ–Ω “Ø—á“Ø–Ω –∞–≤—Ç–æ–±—É—Å—Ç–∞—Ä –∂–æ–∫!', 'error');
               return;
           }

           const templateKey = Date.now().toString();
           const template = {
               name: name,
               description: desc || '–ö–æ–ª–¥–æ–Ω—É—É—á—É —à–∞–±–ª–æ–Ω—É',
               routes: buses.map(bus => ({
                   route: bus.route,
                   time: bus.time,
                   seats: bus.seats,
                   driver: bus.driver,
                   carrier: bus.carrier,
                   price: bus.price
               })),
               created: new Date()
           };

           database.templates[templateKey] = template;
           saveData();
           renderTemplates();
           closeModal();
           showNotification(`${name} —à–∞–±–ª–æ–Ω—É —Å–∞–∫—Ç–∞–ª–¥—ã!`);
       }

       function editTemplate(templateKey) {
           const template = database.templates[templateKey];
           if (!template) return;

           const modalBody = document.getElementById('modal-body');
           modalBody.innerHTML = `
               <div class="form-grid">
                   <div class="form-group">
                       <label>–®–∞–±–ª–æ–Ω –∞—Ç—ã</label>
                       <input type="text" id="edit-template-name" value="${template.name}">
                   </div>
                   <div class="form-group">
                       <label>–°“Ø—Ä”©—Ç—Ç”©–º”©</label>
                       <textarea id="edit-template-desc" rows="3">${template.description}</textarea>
                   </div>
               </div>
               <div style="margin-top: 20px;">
                   <h4 style="color: #3b82f6; margin-bottom: 10px;">–†–µ–π—Å—Ç–µ—Ä:</h4>
                   <div id="template-routes-editor">
                       ${template.routes.map((route, index) => `
                           <div class="route-item" style="margin-bottom: 10px;">
                               <input type="text" value="${route.route}" id="route-${index}" style="width: 120px; margin-right: 10px;">
                               <input type="time" value="${route.time}" id="time-${index}" style="width: 100px; margin-right: 10px;">
                               <input type="number" value="${route.seats}" id="seats-${index}" style="width: 70px; margin-right: 10px;">
                               <input type="number" value="${route.price}" id="price-${index}" style="width: 80px; margin-right: 10px;">
                               <button class="btn btn-small btn-danger" onclick="removeTemplateRoute(${index})">üóëÔ∏è</button>
                           </div>
                       `).join('')}
                   </div>
                   <button class="btn btn-small" onclick="addTemplateRoute()">‚ûï –†–µ–π—Å –∫–æ—à—É—É</button>
               </div>
           `;

           document.getElementById('modal-title').textContent = '–®–∞–±–ª–æ–Ω–¥—É ”©–∑–≥”©—Ä—Ç“Ø“Ø';
           document.getElementById('modal-confirm').onclick = () => confirmEditTemplate(templateKey);
           showModal();
       }

       function confirmEditTemplate(templateKey) {
           const name = document.getElementById('edit-template-name').value.trim();
           const desc = document.getElementById('edit-template-desc').value.trim();

           if (!name) {
               showNotification('–®–∞–±–ª–æ–Ω –∞—Ç—ã–Ω –∂–∞–∑—ã“£—ã–∑!', 'error');
               return;
           }

           // –°–æ–±–∏—Ä–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ä–µ–π—Å—ã
           const routes = [];
           const routeElements = document.querySelectorAll('#template-routes-editor .route-item');
           
           routeElements.forEach((element, index) => {
               const routeInput = element.querySelector(`#route-${index}`);
               const timeInput = element.querySelector(`#time-${index}`);
               const seatsInput = element.querySelector(`#seats-${index}`);
               const priceInput = element.querySelector(`#price-${index}`);
               
               if (routeInput && timeInput && seatsInput && priceInput) {
                   routes.push({
                       route: routeInput.value.trim(),
                       time: timeInput.value,
                       seats: parseInt(seatsInput.value) || 40,
                       driver: '–ê–π–¥–æ–æ—á—É',
                       carrier: '–¢–∞—à—É—É—á—É',
                       price: parseInt(priceInput.value) || 100
                   });
               }
           });

           database.templates[templateKey] = {
               ...database.templates[templateKey],
               name: name,
               description: desc,
               routes: routes
           };

           saveData();
           renderTemplates();
           closeModal();
           showNotification('–®–∞–±–ª–æ–Ω ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø!');
       }

       function deleteTemplate(templateKey) {
           const template = database.templates[templateKey];
           if (!template) return;

           if (confirm(`${template.name} —à–∞–±–ª–æ–Ω—É–Ω ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?`)) {
               delete database.templates[templateKey];
               saveData();
               renderTemplates();
               showNotification('–®–∞–±–ª–æ–Ω ”©—á“Ø—Ä“Ø–ª–¥“Ø');
           }
       }

       function updateAllStatuses(newStatus) {
           if (buses.length === 0) {
               showNotification('–ê–≤—Ç–æ–±—É—Å—Ç–∞—Ä –∂–æ–∫!', 'error');
               return;
           }

           buses.forEach(bus => {
               const oldStatus = bus.status;
               bus.status = newStatus;
               addToHistory('status', bus, { oldStatus, newStatus, type: 'bulk' });
           });

           saveData();
           updateDisplay();
           showNotification(`–ë–∞—Ä–¥—ã–∫ –∞–≤—Ç–æ–±—É—Å—Ç–∞—Ä–¥—ã–Ω —Å—Ç–∞—Ç—É—Å—É "${getStatusText(newStatus)}" –±–æ–ª—É–ø ”©–∑–≥”©—Ä–¥“Ø`);
       }

       function importFromFile() {
           const input = document.createElement('input');
           input.type = 'file';
           input.accept = '.json,.csv';
           input.onchange = function(event) {
               const file = event.target.files[0];
               if (!file) return;

               const reader = new FileReader();
               reader.onload = function(e) {
                   try {
                       if (file.name.endsWith('.json')) {
                           const data = JSON.parse(e.target.result);
                           if (data.buses && Array.isArray(data.buses)) {
                               data.buses.forEach(bus => {
                                   buses.push({
                                       ...bus,
                                       id: busCounter++,
                                       created: new Date()
                                   });
                               });
                               saveData();
                               updateDisplay();
                               showNotification(`${data.buses.length} –∞–≤—Ç–æ–±—É—Å –∏–º–ø–æ—Ä—Ç –±–æ–ª–¥—É!`);
                           }
                       } else if (file.name.endsWith('.csv')) {
                           importFromCSV(e.target.result);
                       }
                   } catch (error) {
                       showNotification('–§–∞–π–ª –æ–∫—É—É–¥–∞ –∫–∞—Ç–∞!', 'error');
                   }
               };
               reader.readAsText(file);
           };
           input.click();
       }

       function importFromCSV(content) {
           const lines = content.split('\n');
           const headers = lines[0].split(',').map(h => h.trim());
           
           let imported = 0;
           for (let i = 1; i < lines.length; i++) {
               const line = lines[i].trim();
               if (!line) continue;

               const values = line.split(',').map(v => v.trim());
               if (values.length < 5) continue;

               const newBus = {
                   id: busCounter++,
                   route: values[0] || '–ë–∞–≥—ã—Ç',
                   time: values[1] || '12:00',
                   seats: parseInt(values[2]) || 40,
                   driver: values[3] || '–ê–π–¥–æ–æ—á—É',
                   carrier: values[4] || '–¢–∞—à—É—É—á—É',
                   price: parseInt(values[5]) || 200,
                   status: 'waiting',
                   date: getTodayDate(),
                   created: new Date(),
                   announcements: {
                       fiveMinutes: false,
                       boarding: false,
                       departed: false
                   }
               };

               buses.push(newBus);
               imported++;
           }

           saveData();
           updateDisplay();
           showNotification(`CSV —Ñ–∞–π–ª—ã–Ω–∞–Ω ${imported} –∞–≤—Ç–æ–±—É—Å –∏–º–ø–æ—Ä—Ç –±–æ–ª–¥—É!`);
       }

       function exportToFile() {
           const data = {
               buses: buses,
               templates: database.templates,
               exported: new Date(),
               version: '2.0'
           };

           const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `karakol-backup-${getTodayDate()}.json`;
           a.click();
           URL.revokeObjectURL(url);
           
           showNotification('–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä —ç–∫—Å–ø–æ—Ä—Ç –±–æ–ª–¥—É!');
       }

       function generateReport() {
           const date = document.getElementById('report-date').value;
           const type = document.getElementById('report-type').value;

           if (!date) {
               showNotification('–û—Ç—á–µ—Ç –∫“Ø–Ω“Ø–Ω —Ç–∞–Ω–¥–∞“£—ã–∑!', 'error');
               return;
           }

           const totalBuses = buses.length;
           const totalSeats = buses.reduce((sum, bus) => sum + bus.seats, 0);
           const totalRevenue = buses.reduce((sum, bus) => sum + (bus.price || 0) * bus.seats, 0);
           const delays = buses.filter(b => b.status === 'delayed').length;

           const container = document.getElementById('report-container');
           container.innerHTML = `
               <div class="stats-grid">
                   <div class="stat-card">
                       <div class="stat-value">${totalBuses}</div>
                       <div class="stat-label">–ë–∞—Ä–¥—ã–≥—ã –∞–≤—Ç–æ–±—É—Å</div>
                   </div>
                   <div class="stat-card">
                       <div class="stat-value">${totalSeats}</div>
                       <div class="stat-label">–ë–∞—Ä–¥—ã–≥—ã –æ—Ä—É–Ω–¥–∞—Ä</div>
                   </div>
                   <div class="stat-card">
                       <div class="stat-value">${totalRevenue.toLocaleString()}</div>
                       <div class="stat-label">–ö–∏—Ä–µ—à–µ (—Å–æ–º)</div>
                   </div>
                   <div class="stat-card">
                       <div class="stat-value">${delays}</div>
                       <div class="stat-label">–ö–µ—á–∏–≥“Ø“Ø–ª”©—Ä</div>
                   </div>
               </div>
               <div class="routes-list">
                   <div class="route-item header">
                       <div>–ë–∞–≥—ã—Ç</div>
                       <div>–£–±–∞–∫—ã—Ç</div>
                       <div>–ê–±–∞–ª—ã</div>
                       <div>–û—Ä—É–Ω–¥–∞—Ä</div>
                       <div>–ë–∞–∞—Å—ã</div>
                       <div>–ö–∏—Ä–µ—à–µ</div>
                       <div></div>
                       <div></div>
                   </div>
                   ${buses.map(bus => `
                       <div class="route-item">
                           <div class="route-field">${bus.route}</div>
                           <div class="route-field route-time">${bus.time}</div>
                           <div class="route-status status-${bus.status}">${getStatusText(bus.status)}</div>
                           <div class="route-field">${bus.seats}</div>
                           <div class="route-field">${bus.price} —Å–æ–º</div>
                           <div class="route-field">${(bus.price * bus.seats).toLocaleString()} —Å–æ–º</div>
                           <div></div>
                           <div></div>
                       </div>
                   `).join('')}
               </div>
           `;

           showNotification('–û—Ç—á–µ—Ç –¥–∞—è—Ä–¥–∞–ª–¥—ã!');
       }

       function exportToPDF() {
           showNotification('PDF —ç–∫—Å–ø–æ—Ä—Ç –∫–∏–π–∏–Ω–∫–∏ –≤–µ—Ä—Å–∏—è–¥–∞ –∫–æ—à—É–ª–∞—Ç', 'warning');
       }

       function exportToExcel() {
           const csvContent = [
               ['–ë–∞–≥—ã—Ç', '–£–±–∞–∫—ã—Ç', '–ê–±–∞–ª—ã', '–û—Ä—É–Ω–¥–∞—Ä', '–ê–π–¥–æ–æ—á—É', '–¢–∞—à—É—É—á—É', '–ë–∞–∞—Å—ã'].join(','),
               ...buses.map(bus => [
                   bus.route,
                   bus.time,
                   getStatusText(bus.status),
                   bus.seats,
                   bus.driver,
                   bus.carrier,
                   bus.price
               ].join(','))
           ].join('\n');

           const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `karakol-report-${getTodayDate()}.csv`;
           a.click();
           URL.revokeObjectURL(url);
           
           showNotification('Excel —Ñ–∞–π–ª—ã —ç–∫—Å–ø–æ—Ä—Ç –±–æ–ª–¥—É!');
       }

       function saveSettings() {
           const settings = {
               updateInterval: document.getElementById('update-interval').value,
               volume: document.getElementById('volume').value,
               autoRemove: document.getElementById('auto-remove').value,
               updated: new Date()
           };

           localStorage.setItem('karakol-settings', JSON.stringify(settings));
           showNotification('–ñ”©–Ω–¥”©”©–ª”©—Ä —Å–∞–∫—Ç–∞–ª–¥—ã!');
       }

       function testAnnouncement() {
           if ('speechSynthesis' in window) {
               const utterance = new SpeechSynthesisUtterance('–ö–∞—Ä–∞–∫–æ–ª –∞–≤—Ç–æ–±–µ–∫–µ—Ç–∏–Ω–∏–Ω —Å–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏');
               utterance.lang = 'ru-RU';
               utterance.volume = 0.8;
               speechSynthesis.speak(utterance);
               showNotification('–î–æ–±—É—à —Ç–µ—Å—Ç–∏ –∏—à—Ç–µ—Ç–∏–ª–¥–∏!');
           } else {
               showNotification('–ë—Ä–∞—É–∑–µ—Ä –¥–æ–±—É—à—Ç—É –∫–æ–ª–¥–æ–±–æ–π—Ç!', 'error');
           }
       }

       function resetSystem() {
           if (confirm('–°–∏—Å—Ç–µ–º–∞–Ω—ã —Ç–æ–ª—É–≥—É –º–µ–Ω–µ–Ω –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä–µ—Å–∏–∑–±–∏? –ë–∞—Ä–¥—ã–∫ –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä –∂–æ–≥–æ–ª–æ—Ç!')) {
               buses = [];
               database = { buses: [], deleted: [], history: [], templates: {} };
               busCounter = 1;
               localStorage.clear();
               updateDisplay();
               renderTemplates();
               showNotification('–°–∏—Å—Ç–µ–º–∞ –±–∞—à—Ç–∞–ø–∫—ã –∞–±–∞–ª–≥–∞ –∫–µ–ª—Ç–∏—Ä–∏–ª–¥–∏!');
           }
       }

       function showModal() {
           document.getElementById('modal').classList.add('show');
       }

       function closeModal() {
           document.getElementById('modal').classList.remove('show');
       }

       function confirmModal() {
           // Placeholder function
       }

       function saveData() {
           try {
               const displayData = {
                   buses: buses,
                   busCounter: busCounter,
                   lastUpdate: new Date().toISOString()
               };
               localStorage.setItem('karakol-bus-station-display', JSON.stringify(displayData));
               localStorage.setItem('karakol-bus-station-db', JSON.stringify(database));
               console.log('–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä —Å–∞–∫—Ç–∞–ª–¥—ã');
           } catch (error) {
               console.error('–°–∞–∫—Ç–æ–æ–¥–æ –∫–∞—Ç–∞:', error);
               showNotification('–°–∞–∫—Ç–æ–æ–¥–æ –∫–∞—Ç–∞!', 'error');
           }
       }

       function loadData() {
           try {
               const saved = localStorage.getItem('karakol-bus-station-display');
               if (saved) {
                   const data = JSON.parse(saved);
                   buses = data.buses || [];
                   busCounter = data.busCounter || 1;
               }
               
               const savedDb = localStorage.getItem('karakol-bus-station-db');
               if (savedDb) {
                   const loadedDb = JSON.parse(savedDb);
                   database = { ...database, ...loadedDb };
               }
               
               updateDisplay();
               renderTemplates();
           } catch (error) {
               console.error('–ñ“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞:', error);
               showNotification('–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞!', 'error');
           }
       }

       // –ì—Ä–æ–º–∫–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª
       document.addEventListener('DOMContentLoaded', function() {
           const volumeSlider = document.getElementById('volume');
           const volumeDisplay = document.getElementById('volume-display');
           
           if (volumeSlider && volumeDisplay) {
               volumeSlider.addEventListener('input', function() {
                   const value = Math.round(this.value * 100);
                   volumeDisplay.textContent = value + '%';
               });
           }
       });

       // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
       window.addEventListener('load', function() {
           // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
           document.getElementById('bus-date').value = getTodayDate();
           document.getElementById('bus-date').min = getTodayDate();
           document.getElementById('history-date').value = getTodayDate();
           document.getElementById('report-date').value = getTodayDate();
           
           loadData();
           setDefaultTime();
           
           // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∫–∞–∂–¥—ã–π —á–∞—Å
           setInterval(() => {
               const dateInput = document.getElementById('bus-date');
               if (dateInput) {
                   dateInput.min = getTodayDate();
               }
           }, 3600000);
           
           console.log('‚öôÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∏—à—Ç–µ—Ç–∏–ª–¥–∏');
           showNotification('–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∂“Ø–∫—Ç”©–ª–¥“Ø!');
       });

       // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
       setInterval(() => {
           if (buses.length > 0) {
               saveData();
           }
       }, 30000);

       // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
       document.getElementById('modal').addEventListener('click', function(e) {
           if (e.target === this) {
               closeModal();
           }
       });

       // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
       document.addEventListener('keydown', function(e) {
           if (e.key === 'Escape') {
               closeModal();
           }
           if (e.ctrlKey && e.key === 's') {
               e.preventDefault();
               saveData();
               showNotification('–ú–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä —Å–∞–∫—Ç–∞–ª–¥—ã!');
           }
       });
   </script>
</body>
</html>